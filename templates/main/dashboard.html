{% extends "base.html" %}

{% block title %}Dashboard - OPIc Practice Portal{% endblock %}

{% block content %}
<style>
/* Ensure heading icons are always visible */
h2 {
    display: flex !important;
    align-items: center;
    flex-wrap: wrap;
}

h2 i.fas,
h2 i.far {
    flex-shrink: 0;
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

h2 small {
    margin-left: 10px;
}

/* Streak fire animations */
.streak-active {
    animation: fireGlow 2s ease-in-out infinite;
    color: #ff9800 !important;
}

.streak-faded {
    opacity: 0.4;
    filter: grayscale(100%);
}

@keyframes fireGlow {
    0%, 100% {
        text-shadow: 0 0 4px rgba(255, 152, 0, 0.6), 0 0 6px rgba(255, 152, 0, 0.4);
        opacity: 1;
    }
    50% {
        text-shadow: 0 0 6px rgba(255, 152, 0, 0.8), 0 0 8px rgba(255, 152, 0, 0.6), 0 0 10px rgba(255, 87, 34, 0.4);
        opacity: 1;
    }
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    h2 {
        font-size: 1.5rem !important;
        margin-bottom: 1rem !important;
    }
    
    h2 i.fas,
    h2 i.far {
        font-size: 1.5rem !important;
        margin-right: 10px !important;
        display: inline-block !important;
        visibility: visible !important;
    }
    
    h2 small {
        font-size: 0.9rem;
        display: block;
        width: 100%;
        margin-left: 0;
        margin-top: 0.5rem;
    }
    
    .card-body {
        padding: 1rem !important;
    }
    
    .card-title {
        font-size: 1rem;
        margin-bottom: 0.75rem;
    }
    
    .btn {
        padding: 0.625rem 1rem;
        font-size: 0.9375rem;
    }
    
    .h4 {
        font-size: 1.5rem;
    }
}

@media (max-width: 576px) {
    .container-fluid {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }
}

@media (max-width: 576px) {
    h2 i.fas,
    h2 i.far {
        font-size: 1.4rem !important;
        margin-right: 8px !important;
    }
}
</style>

<script>
// Function to request notification permission manually
async function requestNotificationPermissionManual() {
    if (!('Notification' in window)) {
        alert('Your browser does not support notifications');
        return;
    }
    
    const button = document.getElementById('enableNotificationsBtn');
    
    if (Notification.permission === 'granted') {
        button.innerHTML = '<i class="fas fa-check me-2"></i>Notifications Enabled';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-success');
        button.disabled = true;
        return;
    }
    
    try {
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
            button.innerHTML = '<i class="fas fa-check me-2"></i>Notifications Enabled';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-success');
            button.disabled = true;
            
            // Show confirmation notification
            new Notification('Streak Reminders Enabled! ðŸ”¥', {
                body: 'We\'ll remind you at 8 PM if you haven\'t practiced today.',
                icon: '/static/icons/icon-192x192.png',
                badge: '/static/icons/icon-96x96.png'
            });
            
            // Start daily reminders
            if (window.scheduleDailyReminder) {
                window.scheduleDailyReminder();
            }
        } else if (permission === 'denied') {
            alert('Notifications blocked. Please enable them in your browser settings.');
        }
    } catch (error) {
        console.error('Error requesting notification permission:', error);
        alert('Failed to enable notifications. Please try again.');
    }
}

// Check notification permission on page load
document.addEventListener('DOMContentLoaded', function() {
    const button = document.getElementById('enableNotificationsBtn');
    
    if (!button) return;
    
    if (!('Notification' in window)) {
        button.style.display = 'none';
        return;
    }
    
    if (Notification.permission === 'granted') {
        button.innerHTML = '<i class="fas fa-check me-2"></i>Notifications Enabled';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-success');
        button.disabled = true;
    } else if (Notification.permission === 'denied') {
        button.innerHTML = '<i class="fas fa-times me-2"></i>Notifications Blocked';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-secondary');
        button.disabled = true;
    }
});
</script>
<div class="container-fluid py-3 py-md-4 px-3 px-md-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-3 mb-md-4 dashboard-heading">
                <i class="fas fa-tachometer-alt"></i>
                <span class="ms-2">Dashboard</span>
                <small class="text-muted d-block d-md-inline">Welcome back, {{ user_stats.user.name }}!</small>
            </h2>
        </div>
    </div>

    <!-- Streak Card -->
    <div class="row mb-3 mb-md-4 g-3" data-streak-status="{{ streak_status }}">
        <div class="col-12 col-md-6">
            <div class="card border-0 shadow-sm {% if streak_status == 'at_risk' %}border-warning{% endif %}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-fire me-2 {% if is_active_today %}text-warning streak-active{% else %}text-muted streak-faded{% endif %}"></i>Daily Streak
                        </h5>
                        <span class="badge {% if is_active_today %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                            {{ user_stats.streak_count }} days
                        </span>
                    </div>
                    <div class="progress mb-2" style="height: 20px;">
                        <div class="progress-bar {% if is_active_today %}bg-success{% else %}bg-secondary{% endif %}" role="progressbar" 
                             style="width: {{ (user_stats.streak_count / 30) * 100 if user_stats.streak_count <= 30 else 100 }}%"></div>
                    </div>
                    <small class="{% if is_active_today %}text-success{% elif streak_status == 'at_risk' %}text-warning{% else %}text-muted{% endif %}">
                        {% if user_stats.streak_count == 0 %}
                            <i class="fas fa-exclamation-circle me-1"></i>Start practicing to build your streak!
                        {% elif is_active_today %}
                            <i class="fas fa-check-circle me-1"></i>Great! You've practiced today! Keep it up! ðŸ”¥
                        {% elif streak_status == 'at_risk' %}
                            <i class="fas fa-bell me-1"></i>Practice today to keep your {{ user_stats.streak_count }}-day streak alive!
                        {% else %}
                            <i class="fas fa-info-circle me-1"></i>Keep practicing daily to maintain your streak!
                        {% endif %}
                    </small>
                    
                    <!-- Notification permission button (only show on mobile) -->
                    <div class="mt-3 d-lg-none">
                        <button id="enableNotificationsBtn" class="btn btn-sm btn-outline-primary w-100" onclick="requestNotificationPermissionManual()">
                            <i class="fas fa-bell me-2"></i>Enable Streak Reminders
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-chart-bar text-primary me-2"></i>Statistics
                    </h5>
                    <div class="row text-center g-3">
                        <div class="col-4">
                            <div class="h4 mb-1 text-primary">{{ user_stats.total_responses }}</div>
                            <small class="text-muted d-block">Responses</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 mb-1 text-success">{{ total_questions }}</div>
                            <small class="text-muted d-block">Questions</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 mb-1 text-warning">{{ user_stats.target_language.title() if user_stats.target_language else 'English' }}</div>
                            <small class="text-muted d-block">Language</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mode Selection -->
    <div class="row mb-3 mb-md-4 g-3">
        <div class="col-12 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">
                        <i class="fas fa-clipboard-list text-primary me-2"></i>Test Mode
                    </h5>
                    <p class="card-text flex-grow-1">
                        Complete a simulated OPIc test with personalized questions based on your survey responses.
                    </p>
                    <div class="mt-auto">
                        <a href="{{ url_for('main.test_mode') }}" class="btn btn-primary w-100">
                            <i class="fas fa-play me-2"></i>Start Test Mode
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-dumbbell text-success me-2"></i>Practice Mode
                    </h5>
                    <p class="card-text flex-grow-1 mb-3">
                        Practice specific topics or random questions to improve your speaking skills.
                    </p>
                    <div class="mt-auto">
                        <a href="{{ url_for('main.practice_mode') }}" class="btn btn-success w-100">
                            <i class="fas fa-play me-2"></i>Start Practice Mode
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tips & Resources and Chatbot Cards -->
    <div class="row mb-3 mb-md-4 g-3">
        <div class="col-12 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-lightbulb text-warning me-2" style="font-size: 2rem;"></i>
                        <h5 class="card-title mb-0">Tips & Resources</h5>
                    </div>
                    <p class="card-text flex-grow-1">
                        Access useful study materials, PDF guides, and tips for OPIc test preparation.
                    </p>
                    <div class="mt-auto">
                        <a href="{{ url_for('main.tips') }}" class="btn btn-warning w-100">
                            <i class="fas fa-book me-2"></i>View Resources
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex align-items-center mb-3">
                        <span class="me-2" style="display:inline-flex; align-items:center;">
                            <img src="/static/galaxyAI.png" alt="Chatbot Icon" class="chatbot-icon-img" style="width: 32px; height: 32px; object-fit: contain;"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                            <i class="fas fa-robot text-info" style="display:none; font-size: 2rem;"></i>
                        </span>
                        <h5 class="card-title mb-0">OPIc Chatbot</h5>
                    </div>
                    <p class="card-text flex-grow-1">
                        Ask questions about OPIc test format, preparation tips, or how to use this app. Get instant AI-powered answers!
                    </p>
                    <div class="mt-auto">
                        <a href="{{ url_for('main.chatbot') }}" class="btn btn-info w-100">
                            <i class="fas fa-comments me-2"></i>Open Chatbot
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    {% if user_stats.recent_responses %}
    <div class="row mb-3 mb-md-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Topic</th>
                                    <th>Level</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for response in user_stats.recent_responses %}
                                <tr>
                                    <td>{{ (response.question.text|unescape_html)[:50] if response.question.text else 'No text available' }}...</td>
                                    <td><span class="badge bg-secondary">{{ response.question.topic if response.question.topic else 'N/A' }}</span></td>
                                    <td>
                                        {% if response.question.difficulty_level %}
                                            <span class="badge bg-primary">{{ response.question.difficulty_level }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ response.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        {% if response.audio_url %}
                                        <button class="btn btn-sm btn-outline-primary" onclick="playAudio('{{ response.audio_url }}')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">No audio</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function playAudio(audioUrl) {
    const audio = new Audio(audioUrl);
    audio.play().catch(e => console.log('Audio playback failed:', e));
}
</script>
{% endblock %}
