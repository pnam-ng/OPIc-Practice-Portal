{% extends "base.html" %}

{% block title %}Profile - OPIc Practice Portal{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-user me-2"></i>User Profile
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Avatar Section -->
                    <div class="row mb-4">
                        <div class="col-12 text-center">
                            <div class="avatar-preview-container">
                                {% if current_user.avatar and current_user.avatar.startswith('uploads/') %}
                                    <img src="/{{ current_user.avatar }}" alt="User Avatar" class="avatar-preview" id="currentAvatar">
                                {% else %}
                                    <img src="{{ url_for('static', filename='avatars/' + (current_user.avatar or 'default1.svg')) }}" alt="User Avatar" class="avatar-preview" id="currentAvatar">
                                {% endif %}
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#avatarModal">
                                <i class="fas fa-camera me-2"></i>Change Avatar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Profile Form -->
                    <form method="POST" action="{{ url_for('main.profile') }}" id="profileForm">
                        <input type="hidden" name="avatar" id="selectedAvatar" value="{{ current_user.avatar or 'default1.svg' }}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" 
                                           value="{{ current_user.username }}" disabled>
                                    <div class="form-text">Username cannot be changed</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ current_user.email }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ current_user.name }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="target_language" class="form-label">Target Language</label>
                                    <select class="form-select" id="target_language" name="target_language">
                                        <option value="english" {% if current_user.target_language == 'english' %}selected{% endif %}>English</option>
                                        <option value="korean" {% if current_user.target_language == 'korean' %}selected{% endif %}>Korean</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Change Password Card -->
            <div class="card shadow mt-4">
                <div class="card-header bg-warning text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.change_password') }}">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="current_password" class="form-label">Current Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-current-password" title="Show/Hide Password">
                                            <i class="fas fa-eye" id="current-password-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="new_password" class="form-label">New Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-key"></i>
                                        </span>
                                        <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-new-password" title="Show/Hide Password">
                                            <i class="fas fa-eye" id="new-password-eye"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">At least 6 characters</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="confirm_new_password" class="form-label">Confirm New Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-key" id="new-password-match-icon"></i>
                                        </span>
                                        <input type="password" class="form-control" id="confirm_new_password" name="confirm_new_password" required minlength="6">
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-confirm-new-password" title="Show/Hide Password">
                                            <i class="fas fa-eye" id="confirm-new-password-eye"></i>
                                        </button>
                                    </div>
                                    <small class="form-text" id="new-password-match-message">Re-enter new password</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-warning text-white">
                                <i class="fas fa-key me-2"></i>Change Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- User Statistics Card -->
            <div class="card shadow mt-4">
                <div class="card-header bg-success text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Your Statistics
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-circle bg-primary text-white">
                                    <i class="fas fa-fire fa-2x"></i>
                                </div>
                                <h5 class="mt-2">{{ user_stats.streak_count or 0 }}</h5>
                                <p class="text-muted">Day Streak</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-circle bg-info text-white">
                                    <i class="fas fa-microphone fa-2x"></i>
                                </div>
                                <h5 class="mt-2">{{ user_stats.total_responses or 0 }}</h5>
                                <p class="text-muted">Total Responses</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-circle bg-warning text-white">
                                    <i class="fas fa-calendar fa-2x"></i>
                                </div>
                                <h5 class="mt-2">{{ current_user.created_at.strftime('%Y-%m-%d') }}</h5>
                                <p class="text-muted">Member Since</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-circle bg-success text-white">
                                    <i class="fas fa-language fa-2x"></i>
                                </div>
                                <h5 class="mt-2">{{ current_user.target_language.title() if current_user.target_language else 'English' }}</h5>
                                <p class="text-muted">Target Language</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity Card -->
            {% if user_stats.recent_responses %}
            <div class="card shadow mt-4">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h4>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for response in user_stats.recent_responses %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ response.question.topic }}</h6>
                                <small>{{ response.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                            <p class="mb-1">{{ response.question.text[:100] }}{% if response.question.text|length > 100 %}...{% endif %}</p>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                {% if response.duration %}
                                    {{ "%.1f"|format(response.duration) }} seconds
                                {% else %}
                                    Duration not recorded
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Quick Actions Card -->
            <div class="card shadow mt-4">
                <div class="card-header bg-secondary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('main.test_mode') }}" class="btn btn-outline-success w-100 mb-2">
                                <i class="fas fa-clipboard-list me-2"></i>Take Test
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('main.practice_mode') }}" class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-dumbbell me-2"></i>Practice
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Avatar Selection Modal -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="avatarModalLabel">
                    <i class="fas fa-user-circle me-2"></i>Choose Your Avatar
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Upload Custom Avatar -->
                <div class="mb-4">
                    <h6 class="mb-3">
                        <i class="fas fa-upload me-2"></i>Upload Custom Avatar
                    </h6>
                    <form id="uploadAvatarForm" enctype="multipart/form-data" onsubmit="return false;">
                        <div class="input-group">
                            <input type="file" class="form-control" id="avatarFile" name="avatar_file" accept="image/*">
                            <button type="button" class="btn btn-primary" id="uploadAvatarBtn">
                                <i class="fas fa-upload me-2"></i>Upload
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Supported formats: JPG, PNG, GIF (Max 5MB)
                        </small>
                    </form>
                    <div id="uploadProgress" class="progress mt-2" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="uploadMessage"></div>
                </div>
                
                <hr>
                
                <!-- Default Avatars -->
                <div>
                    <h6 class="mb-3">
                        <i class="fas fa-images me-2"></i>Select Default Avatar
                    </h6>
                    <div class="row g-3">
                        {% for i in range(1, 7) %}
                        <div class="col-4 col-md-2">
                            <div class="avatar-option" data-avatar="default{{ i }}.svg">
                                <img src="{{ url_for('static', filename='avatars/default' + i|string + '.svg') }}" 
                                     alt="Default Avatar {{ i }}" class="img-fluid rounded-circle">
                                <div class="avatar-checkmark">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAvatarBtn">
                    <i class="fas fa-save me-2"></i>Save Avatar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Avatar Styles */
.avatar-preview-container {
    position: relative;
    display: inline-block;
}

.avatar-preview {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #0d6efd;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.avatar-option {
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid transparent;
    border-radius: 50%;
    overflow: hidden;
}

.avatar-option:hover {
    transform: scale(1.1);
    border-color: #0d6efd;
}

.avatar-option.selected {
    border-color: #0d6efd;
}

.avatar-option img {
    width: 100%;
    height: auto;
    display: block;
}

.avatar-checkmark {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #0d6efd;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.avatar-option.selected .avatar-checkmark {
    display: flex;
}

.stat-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.card {
    border: none;
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn {
    border-radius: 6px;
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}

@media (max-width: 768px) {
    .stat-circle {
        width: 60px;
        height: 60px;
    }
    
    .stat-circle i {
        font-size: 1.5rem !important;
    }
}

.is-valid {
    border-color: #198754 !important;
}

.is-invalid {
    border-color: #dc3545 !important;
}

#new-password-match-icon {
    transition: all 0.3s ease;
}

#confirm_new_password {
    transition: border-color 0.3s ease;
}

/* Password toggle button styles */
#toggle-current-password,
#toggle-new-password,
#toggle-confirm-new-password {
    border-left: none;
    padding: 0.375rem 0.75rem;
    cursor: pointer;
}

#toggle-current-password:hover,
#toggle-new-password:hover,
#toggle-confirm-new-password:hover {
    background-color: #e9ecef;
}

#toggle-current-password:focus,
#toggle-new-password:focus,
#toggle-confirm-new-password:focus {
    box-shadow: none;
    border-color: #ced4da;
}

.input-group > .form-control:not(:last-child) {
    border-right: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Avatar functionality
    let selectedAvatarValue = document.getElementById('selectedAvatar').value;
    
    // Handle default avatar selection
    document.querySelectorAll('.avatar-option').forEach(option => {
        // Mark currently selected avatar
        if (option.dataset.avatar === selectedAvatarValue) {
            option.classList.add('selected');
        }
        
        option.addEventListener('click', function() {
            // Remove selected class from all options
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            this.classList.add('selected');
            selectedAvatarValue = this.dataset.avatar;
        });
    });
    
    // Handle avatar upload - Direct upload on button click
    document.getElementById('uploadAvatarBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const fileInput = document.getElementById('avatarFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select an image file');
            return;
        }
        
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            return;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file');
            return;
        }
        
        const formData = new FormData();
        formData.append('avatar_file', file);
        
        const progressBar = document.getElementById('uploadProgress');
        const progressBarInner = progressBar.querySelector('.progress-bar');
        const uploadBtn = this;
        const originalHTML = uploadBtn.innerHTML;
        
        // Show loading state
        progressBar.style.display = 'block';
        progressBarInner.style.width = '30%';
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
        
        try {
            const response = await fetch('{{ url_for("main.upload_avatar") }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            progressBarInner.style.width = '70%';
            
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            
            const data = await response.json();
            
            progressBarInner.style.width = '100%';
            
            if (data.success) {
                selectedAvatarValue = data.avatar_url;
                
                // Update preview immediately
                const currentAvatar = document.getElementById('currentAvatar');
                currentAvatar.src = '/' + data.avatar_url + '?t=' + new Date().getTime();
                
                // Clear selected default avatars
                document.querySelectorAll('.avatar-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Show success message in modal
                const uploadMessage = document.getElementById('uploadMessage');
                uploadMessage.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show mt-2">
                        <i class="fas fa-check-circle me-2"></i>
                        Avatar uploaded successfully! Click "Save Avatar" to apply.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // Clear file input
                fileInput.value = '';
                
                setTimeout(() => {
                    const alert = uploadMessage.querySelector('.alert');
                    if (alert) {
                        alert.remove();
                    }
                }, 5000);
            } else {
                const uploadMessage = document.getElementById('uploadMessage');
                uploadMessage.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show mt-2">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        ${data.error || 'Upload failed'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Upload error:', error);
            const uploadMessage = document.getElementById('uploadMessage');
            uploadMessage.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show mt-2">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error: ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        } finally {
            // Always reset the UI
            progressBar.style.display = 'none';
            progressBarInner.style.width = '0%';
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalHTML;
        }
    });
    
    // Handle save avatar button
    document.getElementById('saveAvatarBtn').addEventListener('click', function() {
        // Update the hidden input in the profile form
        document.getElementById('selectedAvatar').value = selectedAvatarValue;
        
        // Update the preview
        const currentAvatar = document.getElementById('currentAvatar');
        if (selectedAvatarValue.startsWith('uploads/')) {
            currentAvatar.src = '/' + selectedAvatarValue;
        } else {
            currentAvatar.src = '{{ url_for("static", filename="avatars/") }}' + selectedAvatarValue;
        }
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('avatarModal'));
        modal.hide();
        
        // Show message to save profile
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            Avatar selected! Click "Update Profile" to save your changes.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const cardBody = document.querySelector('.card-body');
        cardBody.insertBefore(alertDiv, cardBody.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    });
    
    // Prevent global loading spinner on profile form submission
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
            // Prevent the global loading spinner
            e.stopPropagation();
            
            // Show our custom loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                const originalHTML = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
                
                // Re-enable after a timeout as fallback
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                }, 5000);
            }
        });
    }
    
    // Password visibility toggles
    const currentPasswordInput = document.getElementById('current_password');
    const newPasswordInput = document.getElementById('new_password');
    const confirmNewPasswordInput = document.getElementById('confirm_new_password');
    
    const toggleCurrentPassword = document.getElementById('toggle-current-password');
    const toggleNewPassword = document.getElementById('toggle-new-password');
    const toggleConfirmNewPassword = document.getElementById('toggle-confirm-new-password');
    
    const currentPasswordEye = document.getElementById('current-password-eye');
    const newPasswordEye = document.getElementById('new-password-eye');
    const confirmNewPasswordEye = document.getElementById('confirm-new-password-eye');
    
    // Toggle current password
    if (toggleCurrentPassword) {
        toggleCurrentPassword.addEventListener('click', function() {
            const type = currentPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            currentPasswordInput.setAttribute('type', type);
            
            if (type === 'text') {
                currentPasswordEye.classList.remove('fa-eye');
                currentPasswordEye.classList.add('fa-eye-slash');
            } else {
                currentPasswordEye.classList.remove('fa-eye-slash');
                currentPasswordEye.classList.add('fa-eye');
            }
        });
    }
    
    // Toggle new password
    if (toggleNewPassword) {
        toggleNewPassword.addEventListener('click', function() {
            const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            newPasswordInput.setAttribute('type', type);
            
            if (type === 'text') {
                newPasswordEye.classList.remove('fa-eye');
                newPasswordEye.classList.add('fa-eye-slash');
            } else {
                newPasswordEye.classList.remove('fa-eye-slash');
                newPasswordEye.classList.add('fa-eye');
            }
        });
    }
    
    // Toggle confirm new password
    if (toggleConfirmNewPassword) {
        toggleConfirmNewPassword.addEventListener('click', function() {
            const type = confirmNewPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmNewPasswordInput.setAttribute('type', type);
            
            if (type === 'text') {
                confirmNewPasswordEye.classList.remove('fa-eye');
                confirmNewPasswordEye.classList.add('fa-eye-slash');
            } else {
                confirmNewPasswordEye.classList.remove('fa-eye-slash');
                confirmNewPasswordEye.classList.add('fa-eye');
            }
        });
    }
    
    // Real-time password match checking for Change Password form
    const matchMessage = document.getElementById('new-password-match-message');
    const matchIcon = document.getElementById('new-password-match-icon');
    
    if (newPasswordInput && confirmNewPasswordInput) {
        function checkNewPasswordMatch() {
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;
            
            // Only check if confirm password field has content
            if (confirmNewPassword.length === 0) {
                // Reset to default state
                matchMessage.textContent = 'Re-enter new password';
                matchMessage.className = 'form-text text-muted';
                confirmNewPasswordInput.classList.remove('is-valid', 'is-invalid');
                matchIcon.className = 'fas fa-key';
                return;
            }
            
            // Check if passwords match
            if (newPassword === confirmNewPassword && newPassword.length >= 6) {
                // Passwords match and meet length requirement
                matchMessage.textContent = '✓ Passwords match';
                matchMessage.className = 'form-text text-success';
                confirmNewPasswordInput.classList.remove('is-invalid');
                confirmNewPasswordInput.classList.add('is-valid');
                matchIcon.className = 'fas fa-check-circle text-success';
            } else if (newPassword === confirmNewPassword && newPassword.length < 6) {
                // Passwords match but too short
                matchMessage.textContent = '⚠ Passwords match but too short (min 6 characters)';
                matchMessage.className = 'form-text text-warning';
                confirmNewPasswordInput.classList.remove('is-valid');
                confirmNewPasswordInput.classList.add('is-invalid');
                matchIcon.className = 'fas fa-exclamation-circle text-warning';
            } else {
                // Passwords don't match
                matchMessage.textContent = '✗ Passwords do not match';
                matchMessage.className = 'form-text text-danger';
                confirmNewPasswordInput.classList.remove('is-valid');
                confirmNewPasswordInput.classList.add('is-invalid');
                matchIcon.className = 'fas fa-times-circle text-danger';
            }
        }
        
        // Add event listeners for real-time checking
        newPasswordInput.addEventListener('input', checkNewPasswordMatch);
        confirmNewPasswordInput.addEventListener('input', checkNewPasswordMatch);
        
        // Also check on blur (when user leaves the field)
        confirmNewPasswordInput.addEventListener('blur', checkNewPasswordMatch);
    }
});
</script>
{% endblock %}

