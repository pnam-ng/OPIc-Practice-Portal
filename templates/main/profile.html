{% extends "base.html" %}

{% block title %}Profile - OPIc Practice Portal{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-user me-2"></i>User Profile
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Profile Form -->
                    <form method="POST" action="{{ url_for('main.profile') }}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" 
                                           value="{{ current_user.username }}" disabled>
                                    <div class="form-text">Username cannot be changed</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ current_user.email }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ current_user.name }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="target_language" class="form-label">Target Language</label>
                                    <select class="form-select" id="target_language" name="target_language">
                                        <option value="english" {% if current_user.target_language == 'english' %}selected{% endif %}>English</option>
                                        <option value="korean" {% if current_user.target_language == 'korean' %}selected{% endif %}>Korean</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Change Password Card -->
            <div class="card shadow mt-4">
                <div class="card-header bg-warning text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>Change Password
                    </h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.change_password') }}">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="current_password" class="form-label">Current Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-current-password" title="Show/Hide Password">
                                            <i class="fas fa-eye" id="current-password-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="new_password" class="form-label">New Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-key"></i>
                                        </span>
                                        <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-new-password" title="Show/Hide Password">
                                            <i class="fas fa-eye" id="new-password-eye"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">At least 6 characters</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="confirm_new_password" class="form-label">Confirm New Password</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-key" id="new-password-match-icon"></i>
                                        </span>
                                        <input type="password" class="form-control" id="confirm_new_password" name="confirm_new_password" required minlength="6">
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-confirm-new-password" title="Show/Hide Password">
                                            <i class="fas fa-eye" id="confirm-new-password-eye"></i>
                                        </button>
                                    </div>
                                    <small class="form-text" id="new-password-match-message">Re-enter new password</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-warning text-white">
                                <i class="fas fa-key me-2"></i>Change Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- User Statistics Card -->
            <div class="card shadow mt-4">
                <div class="card-header bg-success text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Your Statistics
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-circle bg-primary text-white">
                                    <i class="fas fa-fire fa-2x"></i>
                                </div>
                                <h5 class="mt-2">{{ user_stats.streak_count or 0 }}</h5>
                                <p class="text-muted">Day Streak</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-circle bg-info text-white">
                                    <i class="fas fa-microphone fa-2x"></i>
                                </div>
                                <h5 class="mt-2">{{ user_stats.total_responses or 0 }}</h5>
                                <p class="text-muted">Total Responses</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-circle bg-warning text-white">
                                    <i class="fas fa-calendar fa-2x"></i>
                                </div>
                                <h5 class="mt-2">{{ current_user.created_at.strftime('%Y-%m-%d') }}</h5>
                                <p class="text-muted">Member Since</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="stat-circle bg-success text-white">
                                    <i class="fas fa-language fa-2x"></i>
                                </div>
                                <h5 class="mt-2">{{ current_user.target_language.title() if current_user.target_language else 'English' }}</h5>
                                <p class="text-muted">Target Language</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity Card -->
            {% if user_stats.recent_responses %}
            <div class="card shadow mt-4">
                <div class="card-header bg-info text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h4>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for response in user_stats.recent_responses %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ response.question.topic }}</h6>
                                <small>{{ response.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                            <p class="mb-1">{{ response.question.text[:100] }}{% if response.question.text|length > 100 %}...{% endif %}</p>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                {% if response.duration %}
                                    {{ "%.1f"|format(response.duration) }} seconds
                                {% else %}
                                    Duration not recorded
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Quick Actions Card -->
            <div class="card shadow mt-4">
                <div class="card-header bg-secondary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('main.test_mode') }}" class="btn btn-outline-success w-100 mb-2">
                                <i class="fas fa-clipboard-list me-2"></i>Take Test
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('main.practice_mode') }}" class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-dumbbell me-2"></i>Practice
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.card {
    border: none;
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn {
    border-radius: 6px;
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}

@media (max-width: 768px) {
    .stat-circle {
        width: 60px;
        height: 60px;
    }
    
    .stat-circle i {
        font-size: 1.5rem !important;
    }
}

.is-valid {
    border-color: #198754 !important;
}

.is-invalid {
    border-color: #dc3545 !important;
}

#new-password-match-icon {
    transition: all 0.3s ease;
}

#confirm_new_password {
    transition: border-color 0.3s ease;
}

/* Password toggle button styles */
#toggle-current-password,
#toggle-new-password,
#toggle-confirm-new-password {
    border-left: none;
    padding: 0.375rem 0.75rem;
    cursor: pointer;
}

#toggle-current-password:hover,
#toggle-new-password:hover,
#toggle-confirm-new-password:hover {
    background-color: #e9ecef;
}

#toggle-current-password:focus,
#toggle-new-password:focus,
#toggle-confirm-new-password:focus {
    box-shadow: none;
    border-color: #ced4da;
}

.input-group > .form-control:not(:last-child) {
    border-right: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password visibility toggles
    const currentPasswordInput = document.getElementById('current_password');
    const newPasswordInput = document.getElementById('new_password');
    const confirmNewPasswordInput = document.getElementById('confirm_new_password');
    
    const toggleCurrentPassword = document.getElementById('toggle-current-password');
    const toggleNewPassword = document.getElementById('toggle-new-password');
    const toggleConfirmNewPassword = document.getElementById('toggle-confirm-new-password');
    
    const currentPasswordEye = document.getElementById('current-password-eye');
    const newPasswordEye = document.getElementById('new-password-eye');
    const confirmNewPasswordEye = document.getElementById('confirm-new-password-eye');
    
    // Toggle current password
    if (toggleCurrentPassword) {
        toggleCurrentPassword.addEventListener('click', function() {
            const type = currentPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            currentPasswordInput.setAttribute('type', type);
            
            if (type === 'text') {
                currentPasswordEye.classList.remove('fa-eye');
                currentPasswordEye.classList.add('fa-eye-slash');
            } else {
                currentPasswordEye.classList.remove('fa-eye-slash');
                currentPasswordEye.classList.add('fa-eye');
            }
        });
    }
    
    // Toggle new password
    if (toggleNewPassword) {
        toggleNewPassword.addEventListener('click', function() {
            const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            newPasswordInput.setAttribute('type', type);
            
            if (type === 'text') {
                newPasswordEye.classList.remove('fa-eye');
                newPasswordEye.classList.add('fa-eye-slash');
            } else {
                newPasswordEye.classList.remove('fa-eye-slash');
                newPasswordEye.classList.add('fa-eye');
            }
        });
    }
    
    // Toggle confirm new password
    if (toggleConfirmNewPassword) {
        toggleConfirmNewPassword.addEventListener('click', function() {
            const type = confirmNewPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmNewPasswordInput.setAttribute('type', type);
            
            if (type === 'text') {
                confirmNewPasswordEye.classList.remove('fa-eye');
                confirmNewPasswordEye.classList.add('fa-eye-slash');
            } else {
                confirmNewPasswordEye.classList.remove('fa-eye-slash');
                confirmNewPasswordEye.classList.add('fa-eye');
            }
        });
    }
    
    // Real-time password match checking for Change Password form
    const matchMessage = document.getElementById('new-password-match-message');
    const matchIcon = document.getElementById('new-password-match-icon');
    
    if (newPasswordInput && confirmNewPasswordInput) {
        function checkNewPasswordMatch() {
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;
            
            // Only check if confirm password field has content
            if (confirmNewPassword.length === 0) {
                // Reset to default state
                matchMessage.textContent = 'Re-enter new password';
                matchMessage.className = 'form-text text-muted';
                confirmNewPasswordInput.classList.remove('is-valid', 'is-invalid');
                matchIcon.className = 'fas fa-key';
                return;
            }
            
            // Check if passwords match
            if (newPassword === confirmNewPassword && newPassword.length >= 6) {
                // Passwords match and meet length requirement
                matchMessage.textContent = '✓ Passwords match';
                matchMessage.className = 'form-text text-success';
                confirmNewPasswordInput.classList.remove('is-invalid');
                confirmNewPasswordInput.classList.add('is-valid');
                matchIcon.className = 'fas fa-check-circle text-success';
            } else if (newPassword === confirmNewPassword && newPassword.length < 6) {
                // Passwords match but too short
                matchMessage.textContent = '⚠ Passwords match but too short (min 6 characters)';
                matchMessage.className = 'form-text text-warning';
                confirmNewPasswordInput.classList.remove('is-valid');
                confirmNewPasswordInput.classList.add('is-invalid');
                matchIcon.className = 'fas fa-exclamation-circle text-warning';
            } else {
                // Passwords don't match
                matchMessage.textContent = '✗ Passwords do not match';
                matchMessage.className = 'form-text text-danger';
                confirmNewPasswordInput.classList.remove('is-valid');
                confirmNewPasswordInput.classList.add('is-invalid');
                matchIcon.className = 'fas fa-times-circle text-danger';
            }
        }
        
        // Add event listeners for real-time checking
        newPasswordInput.addEventListener('input', checkNewPasswordMatch);
        confirmNewPasswordInput.addEventListener('input', checkNewPasswordMatch);
        
        // Also check on blur (when user leaves the field)
        confirmNewPasswordInput.addEventListener('blur', checkNewPasswordMatch);
    }
});
</script>
{% endblock %}

