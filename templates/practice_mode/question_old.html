{% extends "base.html" %}

{% block title %}Practice Question - OPIc Practice Portal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 sidebar">
            <div class="sidebar-content">
                <h4 class="sidebar-title">Practice Session</h4>
                
                <!-- Question Info -->
                <div class="practice-section">
                    <h5>Question Details</h5>
                    <div class="question-info">
                        <div class="info-item">
                            <span class="info-label">Topic:</span>
                            <span class="info-value">{{ question.topic }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Difficulty:</span>
                            <span class="info-value">{{ question.difficulty.title() }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Language:</span>
                            <span class="info-value">{{ question.language.title() }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recording Controls -->
                <div class="practice-section">
                    <h5>Recording</h5>
                    <div class="recording-controls">
                        <button id="recordBtn" class="btn btn-danger btn-block">
                            <i class="fas fa-microphone"></i> Start Recording
                        </button>
                        <button id="stopBtn" class="btn btn-secondary btn-block" disabled>
                            <i class="fas fa-stop"></i> Stop Recording
                        </button>
                        <button id="playBtn" class="btn btn-info btn-block" disabled>
                            <i class="fas fa-play"></i> Play Back
                        </button>
                        <button id="submitBtn" class="btn btn-success btn-block" disabled>
                            <i class="fas fa-check"></i> Submit Response
                        </button>
                    </div>
                    
                    <!-- Recording Status -->
                    <div class="recording-status" id="recordingStatus" style="display: none;">
                        <div class="status-indicator">
                            <i class="fas fa-circle recording-pulse"></i>
                            <span>Recording...</span>
                        </div>
                        <div class="recording-timer" id="recordingTimer">00:00</div>
                    </div>
                </div>
                
                <!-- Navigation -->
                <div class="practice-section">
                    <h5>Navigation</h5>
                    <div class="navigation-controls">
                        <a href="{{ url_for('practice_mode.index') }}" class="btn btn-outline-secondary btn-block">
                            <i class="fas fa-arrow-left"></i> Back to Practice
                        </a>
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary btn-block">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9 main-content">
            <div class="question-container">
                <!-- Question Header -->
                <div class="question-header">
                    <h2><i class="fas fa-question-circle"></i> Practice Question</h2>
                    <p class="question-subtitle">Take your time to think and respond</p>
                </div>
                
                <!-- Question Audio -->
                <div class="question-audio">
                    <h4><i class="fas fa-volume-up"></i> Listen to the Question</h4>
                    <div class="audio-player">
                        <button id="playQuestionBtn" class="btn btn-primary btn-lg">
                            <i class="fas fa-play"></i> Play Question
                        </button>
                        <div class="audio-info">
                            <span class="audio-duration" id="audioDuration">--:--</span>
                        </div>
                    </div>
                </div>
                
                <!-- Question Text -->
                <div class="question-text">
                    <h4><i class="fas fa-file-text"></i> Question Text</h4>
                    <div class="text-content">
                        {{ question.text }}
                    </div>
                </div>
                
                <!-- Response Area -->
                <div class="response-area">
                    <h4><i class="fas fa-microphone"></i> Your Response</h4>
                    
                    <!-- Microphone Permission Alert -->
                    <div class="alert alert-info" id="micPermissionAlert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Microphone Access Required:</strong>
                        <p class="mb-0 mt-2">This page needs microphone access to record your response. When you click "Start Recording", your browser will ask for permission. Please click "Allow" to continue.</p>
                        <p class="mb-0 mt-2 small">
                            <i class="fas fa-shield-alt me-1"></i>
                            Your audio is only stored on this server and is never shared with third parties.
                        </p>
                    </div>
                    
                    <div class="response-instructions">
                        <p>Click "Start Recording" when you're ready to answer. Take your time to think about your response first.</p>
                    </div>
                    
                    <!-- Audio Visualization -->
                    <div class="audio-visualization" id="audioVisualization" style="display: none;">
                        <canvas id="audioCanvas" width="400" height="100"></canvas>
                    </div>
                    
                    <!-- Response Status -->
                    <div class="response-status" id="responseStatus" style="display: none;">
                        <div class="status-message">
                            <i class="fas fa-check-circle"></i>
                            <span>Response recorded successfully!</span>
                        </div>
                    </div>
                </div>
                
                <!-- Practice Tips -->
                <div class="practice-tips">
                    <h5><i class="fas fa-lightbulb"></i> Practice Tips</h5>
                    <ul>
                        <li>Listen to the question carefully before responding</li>
                        <li>Take a moment to organize your thoughts</li>
                        <li>Speak clearly and at a comfortable pace</li>
                        <li>Don't worry about making mistakes - this is practice!</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for submitting response -->
<form id="responseForm" method="POST" action="{{ url_for('practice_mode.record_practice_response', question_id=question.id) }}" style="display: none;">
    <input type="file" id="audioFile" name="audio" accept="audio/*">
</form>

<style>
.sidebar {
    background-color: #f8f9fa;
    min-height: calc(100vh - 56px);
    padding: 20px;
    border-right: 1px solid #dee2e6;
}

.sidebar-content {
    position: sticky;
    top: 20px;
}

.sidebar-title {
    color: #495057;
    margin-bottom: 20px;
    font-weight: 600;
}

.practice-section {
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.practice-section h5 {
    color: #495057;
    margin-bottom: 15px;
    font-weight: 600;
}

.question-info {
    margin-top: 15px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.info-label {
    color: #6c757d;
    font-weight: 500;
}

.info-value {
    color: #007bff;
    font-weight: 600;
}

.btn-block {
    width: 100%;
    margin-bottom: 10px;
    padding: 12px;
    border-radius: 6px;
    font-weight: 500;
}

.recording-status {
    margin-top: 15px;
    text-align: center;
}

.status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

.recording-pulse {
    color: #dc3545;
    animation: pulse 1s infinite;
    margin-right: 8px;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.recording-timer {
    font-size: 1.2rem;
    font-weight: 600;
    color: #dc3545;
}

.navigation-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.main-content {
    padding: 30px;
}

.question-container {
    max-width: 800px;
    margin: 0 auto;
}

.question-header {
    text-align: center;
    margin-bottom: 40px;
}

.question-header h2 {
    color: #495057;
    margin-bottom: 10px;
}

.question-subtitle {
    color: #6c757d;
    font-size: 1.1rem;
}

.question-audio, .question-text, .response-area, .practice-tips {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.question-audio h4, .question-text h4, .response-area h4, .practice-tips h5 {
    color: #495057;
    margin-bottom: 20px;
    font-weight: 600;
}

.audio-player {
    display: flex;
    align-items: center;
    gap: 20px;
}

.audio-info {
    color: #6c757d;
}

.text-content {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
    font-size: 1.1rem;
    line-height: 1.6;
    color: #495057;
}

.response-instructions {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #2196f3;
}

.response-instructions p {
    margin: 0;
    color: #1976d2;
}

.audio-visualization {
    margin: 20px 0;
    text-align: center;
}

#audioCanvas {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: #f8f9fa;
}

.response-status {
    margin-top: 20px;
    text-align: center;
}

.status-message {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #28a745;
    font-weight: 500;
}

.status-message i {
    margin-right: 8px;
    font-size: 1.2rem;
}

.practice-tips ul {
    margin: 0;
    padding-left: 20px;
}

.practice-tips li {
    margin-bottom: 10px;
    color: #6c757d;
    line-height: 1.5;
}

@media (max-width: 768px) {
    .sidebar {
        min-height: auto;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
    }
    
    .main-content {
        padding: 20px;
    }
    
    .question-audio, .question-text, .response-area, .practice-tips {
        padding: 20px;
    }
    
    .audio-player {
        flex-direction: column;
        gap: 10px;
    }
}
</style>

<script>
let mediaRecorder;
let audioChunks = [];
let recordingStartTime;
let recordingTimer;

// Audio context for visualization
let audioContext;
let analyser;
let microphone;
let dataArray;

// DOM elements
const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const playBtn = document.getElementById('playBtn');
const submitBtn = document.getElementById('submitBtn');
const playQuestionBtn = document.getElementById('playQuestionBtn');
const recordingStatus = document.getElementById('recordingStatus');
const recordingTimerEl = document.getElementById('recordingTimer');
const audioVisualization = document.getElementById('audioVisualization');
const audioCanvas = document.getElementById('audioCanvas');
const responseStatus = document.getElementById('responseStatus');
const responseForm = document.getElementById('responseForm');
const audioFile = document.getElementById('audioFile');

// Question audio
const questionAudio = new Audio('{{ question.audio_url or "/static/audio/sample.mp3" }}');

// Event listeners
recordBtn.addEventListener('click', startRecording);
stopBtn.addEventListener('click', stopRecording);
playBtn.addEventListener('click', playRecording);
submitBtn.addEventListener('click', submitResponse);
playQuestionBtn.addEventListener('click', playQuestion);

// Play question audio
function playQuestion() {
    if (questionAudio.paused) {
        questionAudio.play();
        playQuestionBtn.innerHTML = '<i class="fas fa-pause"></i> Pause Question';
    } else {
        questionAudio.pause();
        playQuestionBtn.innerHTML = '<i class="fas fa-play"></i> Play Question';
    }
}

// Start recording
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // Create audio element for playback
            const audio = new Audio(audioUrl);
            audio.onloadedmetadata = () => {
                playBtn.disabled = false;
                submitBtn.disabled = false;
            };
            
            // Store blob for submission
            audioFile.files = [new File([audioBlob], 'response.webm', { type: 'audio/webm' })];
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        // Update UI
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        recordingStatus.style.display = 'block';
        audioVisualization.style.display = 'block';
        
        // Start timer
        recordingTimer = setInterval(updateTimer, 1000);
        
        // Start audio visualization
        startAudioVisualization(stream);
        
    } catch (error) {
        console.error('Error starting recording:', error);
        
        let errorMessage = 'Unable to access microphone.\n\n';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage += 'Permission denied. Please:\n';
            errorMessage += '1. Click the lock/camera icon in the address bar\n';
            errorMessage += '2. Allow microphone access for this site\n';
            errorMessage += '3. Refresh the page and try again';
        } else if (error.name === 'NotFoundError') {
            errorMessage += 'No microphone found. Please connect a microphone and try again.';
        } else {
            errorMessage += 'Error: ' + error.message + '\n\n';
            errorMessage += 'Please check your browser settings and allow microphone access.';
        }
        
        alert(errorMessage);
    }
}

// Stop recording
function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        
        // Update UI
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        recordingStatus.style.display = 'none';
        audioVisualization.style.display = 'none';
        
        // Stop timer
        clearInterval(recordingTimer);
        
        // Stop audio visualization
        if (audioContext) {
            audioContext.close();
        }
    }
}

// Play recording
function playRecording() {
    const audio = new Audio();
    audio.src = URL.createObjectURL(new Blob(audioChunks, { type: 'audio/webm' }));
    audio.play();
}

// Submit response
function submitResponse() {
    if (audioFile.files.length > 0) {
        responseForm.submit();
    }
}

// Update recording timer
function updateTimer() {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    recordingTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Start audio visualization
function startAudioVisualization(stream) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    microphone = audioContext.createMediaStreamSource(stream);
    
    microphone.connect(analyser);
    analyser.fftSize = 256;
    
    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    
    draw();
}

// Draw audio visualization
function draw() {
    if (!analyser) return;
    
    requestAnimationFrame(draw);
    
    analyser.getByteFrequencyData(dataArray);
    
    const canvas = audioCanvas;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(0, 0, width, height);
    
    const barWidth = (width / dataArray.length) * 2.5;
    let barHeight;
    let x = 0;
    
    for (let i = 0; i < dataArray.length; i++) {
        barHeight = (dataArray[i] / 255) * height;
        
        ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
        ctx.fillRect(x, height - barHeight, barWidth, barHeight);
        
        x += barWidth + 1;
    }
}

// Question audio events
questionAudio.addEventListener('loadedmetadata', () => {
    const duration = Math.floor(questionAudio.duration);
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    document.getElementById('audioDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
});

questionAudio.addEventListener('ended', () => {
    playQuestionBtn.innerHTML = '<i class="fas fa-play"></i> Play Question';
});
</script>
{% endblock %}
