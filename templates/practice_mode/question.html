{% extends "base.html" %}

{% block title %}Practice Question - OPIc Practice Portal{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4">
    <div class="row g-3 g-md-4">
        <!-- Sidebar -->
        <div class="col-12 col-md-3 sidebar">
            <div class="sidebar-content">
                <h4 class="sidebar-title">Practice Session</h4>
                
                <!-- Question Info -->
                <div class="practice-section">
                    <h5>Question Details</h5>
                    <div class="question-info">
                        <div class="info-item">
                            <span class="info-label">Level:</span>
                            <span class="info-value level-badge">{{ question.difficulty_level }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Topic:</span>
                            <span class="info-value">{{ question.topic }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Language:</span>
                            <span class="info-value">{{ question.language.title() if question.language else 'English' }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recording Status removed - timer is already in "Your Response" section -->
                
                <!-- Navigation -->
                <div class="practice-section">
                    <h5>Navigation</h5>
                    <div class="navigation-controls">
                        <a href="{{ url_for('practice_mode.index') }}" class="btn btn-outline-secondary btn-block">
                            <i class="fas fa-arrow-left"></i> Back to Practice
                        </a>
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary btn-block">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-12 col-md-9 main-content">
            <div class="question-container">
                <!-- Mobile Topic Badge (Simple) -->
                <div class="mobile-topic-badge d-md-none">
                    <span class="badge-level">{{ question.difficulty_level }}</span> {{ question.topic }}
                </div>
                
                <!-- Question Header -->
                <div class="question-header">
                    <h2 class="d-none d-md-block"><i class="fas fa-question-circle"></i> Practice Question</h2>
                    <h5 class="d-md-none mb-2">Practice Question</h5>
                    <p class="question-subtitle d-none d-md-block">Take your time to think and respond</p>
                </div>
                
                <!-- Question & Sample Section Card -->
                <div class="question-card">
                    <div class="card-section">
                        <div class="section-title">
                            <i class="fas fa-headphones text-primary"></i>
                            <span>Question Audio</span>
                        </div>
                        <div class="audio-player">
                            <button id="playQuestionBtn" class="btn btn-primary btn-player">
                                <i class="fas fa-play"></i>
                                
                            </button>
                            <div class="player-progress">
                                <input type="range" id="questionProgress" class="progress-slider" min="0" max="100" value="0">
                                <div class="time-display">
                                    <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-light d-none d-md-block" onclick="toggleMute('question')" id="volumeBtnQuestion">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <input type="range" id="volumeQuestion" class="volume-slider d-none d-md-block" min="0" max="100" value="100">
                        </div>
                        <button id="toggleTextBtn" class="btn-toggle-text" onclick="toggleQuestionText()">
                            <i class="fas fa-eye"></i>
                            <span>Show Question</span>
                        </button>
                        <div id="questionTextContent" class="toggle-content" style="display: none;">
                            <div class="text-content">{{ question.text|unescape_html|safe }}</div>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <div class="card-section">
                        <div class="section-title">
                            <i class="fas fa-lightbulb text-warning"></i>
                            <span>Sample Answer from Multicampus</span>
                            <button id="toggleSampleBtn" class="btn-show-hide ms-auto" onclick="toggleSampleAnswer()">
                                <i class="fas fa-chevron-down"></i>
                                <span>Show</span>
                            </button>
                        </div>
                        <div id="sampleAnswerContent" style="display: none;">
                            <div class="audio-player mt-3">
                                <button id="playSampleBtn" class="btn btn-warning btn-player">
                                    <i class="fas fa-play"></i>
                                    <span class="d-none d-sm-inline ms-2"></span>
                                </button>
                                <div class="player-progress">
                                    <input type="range" id="sampleProgress" class="progress-slider" min="0" max="100" value="0">
                                    <div class="time-display">
                                        <span id="sampleCurrentTime">0:00</span> / <span id="sampleDuration">0:00</span>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-light d-none d-md-block" onclick="toggleMute('sample')" id="volumeBtnSample">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <input type="range" id="volumeSample" class="volume-slider d-none d-md-block" min="0" max="100" value="100">
                            </div>
                            <div class="sample-answer-text mt-3" id="sampleAnswerText">
                                <em class="text-muted">Loading sample answer...</em>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Response Section - Desktop Only -->
                <div class="response-card d-none d-md-block">
                    <div class="section-title">
                        <i class="fas fa-microphone text-danger"></i>
                        <span>Your Response</span>
                        <div class="recording-timer ms-auto" id="recordingStatusInline" style="display: none;">
                            <i class="fas fa-circle pulse-animation"></i>
                            <span id="recordingTimerInline">02:00</span>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning py-2 px-3 mb-2 small" id="recordWarning" style="display: block;">
                        <i class="fas fa-info-circle me-1"></i>Please play the question audio before recording
                    </div>
                    
                    <!-- Live Transcription Display -->
                    <div id="transcriptIndicator" class="alert alert-info py-2 px-3 mb-2 small" style="display: none;">
                        <i class="fas fa-microphone-alt me-1"></i>
                        <strong>Transcribing...</strong> Your speech is being transcribed automatically.
                    </div>
                    <div id="transcriptContainer" class="mb-3" style="display: none;">
                        <label class="form-label small"><i class="fas fa-file-alt me-1"></i>Live Transcript:</label>
                        <textarea id="liveTranscript" class="form-control form-control-sm" rows="2" readonly placeholder="Your transcript will appear here as you speak..."></textarea>
                    </div>
                    
                    <div class="response-controls">
                        <button id="recordBtn" class="btn-response btn-record" disabled style="opacity: 0.5; cursor: not-allowed;" title="Play the question audio first">
                            <i class="fas fa-microphone"></i>
                            <span>Record</span>
                        </button>
                        <button id="stopBtn" class="btn-response btn-stop" disabled>
                            <i class="fas fa-stop"></i>
                            <span>Stop</span>
                        </button>
                    </div>
                    
                    <div class="audio-visualization" id="audioVisualization" style="display: none;">
                        <canvas id="audioCanvas" width="600" height="50"></canvas>
                    </div>
                    
                    <div id="playbackSection" style="display: none;">
                        <div class="audio-player mb-3">
                            <button id="playBtn" class="btn btn-success btn-player">
                                <i class="fas fa-play"></i>
                            </button>
                            <button id="pauseBtn" class="btn btn-success btn-player" style="display: none;">
                                <i class="fas fa-pause"></i>
                            </button>
                            <div class="player-progress">
                                <input type="range" id="playbackProgress" class="progress-slider" min="0" max="100" value="0">
                                <div class="time-display">
                                    <span id="playbackCurrentTime">0:00</span> / <span id="playbackDuration">0:00</span>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-light d-none d-md-block" onclick="toggleMute('playback')" id="volumeBtnPlayback">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <input type="range" id="volumePlayback" class="volume-slider d-none d-md-block" min="0" max="100" value="100">
                        </div>
                        
                        <div class="playback-actions-bar">
                            <button id="downloadBtn" class="btn-playback btn-download">
                                <i class="fas fa-download"></i>
                                <span>Download</span>
                            </button>
                            <button id="submitBtn" class="btn-submit-response">
                                <i class="fas fa-paper-plane"></i>
                                <span>Submit Response</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Comments Section -->
                <div class="comments-section mt-4">
                    <div class="comment-card">
                        <!-- Comments Header -->
                        <div class="comments-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="comments-title mb-0">
                                    Comments
                                    <span class="comments-badge" id="commentsCount">0</span>
                                </h5>
                                <div class="comments-sort">
                                    <select class="form-select form-select-sm" id="commentsSortSelect" onchange="sortComments(this.value)">
                                        <option value="recent" selected>Most recent</option>
                                        <option value="popular">Most popular</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Comment Input Area -->
                        <div class="comment-input-area">
                                <div style="position: relative;">
                                <textarea class="comment-textarea" id="newCommentText" rows="3" 
                                          placeholder="Add comment..." maxlength="2200"
                                          oninput="autoResizeTextarea(this); updateCharCount()"></textarea>
                                    <div id="mentionDropdown" class="mention-dropdown"></div>
                                </div>
                            
                            <!-- Formatting Toolbar -->
                            <div class="formatting-toolbar">
                                <button type="button" class="format-btn" onclick="formatText('bold')" title="Bold">
                                    <strong>B</strong>
                                        </button>
                                <button type="button" class="format-btn" onclick="formatText('italic')" title="Italic">
                                    <em>I</em>
                                </button>
                                <button type="button" class="format-btn" onclick="formatText('underline')" title="Underline">
                                    <u>U</u>
                                </button>
                                <button type="button" class="format-btn" onclick="insertLink()" title="Link">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button type="button" class="format-btn" onclick="toggleAudioUpload()" title="Upload audio">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button type="button" class="format-btn" onclick="insertEmoji()" title="Emoji">
                                    <i class="far fa-smile"></i>
                                </button>
                                <button type="button" class="format-btn" onclick="triggerMention()" title="Mention">
                                    <i class="fas fa-at"></i>
                                </button>
                            </div>

                            <!-- Audio Upload (Hidden by default) -->
                            <div class="mt-2" id="commentAudioUploadSection" style="display: none;">
                                <div class="audio-upload-container">
                                    <input type="file" class="d-none" id="commentAudioFile" accept="audio/*" onchange="handleCommentAudioChange(this)" />
                                        <div id="commentAudioPreview" class="mt-2" style="display: none;">
                                        <div class="d-flex align-items-center justify-content-between bg-light rounded p-2 audio-file-preview">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-file-audio text-primary me-2"></i>
                                                    <div>
                                                        <small class="d-block fw-bold" id="commentAudioPreviewName"></small>
                                                        <small class="text-muted" id="commentAudioPreviewSize"></small>
                                                    </div>
                                                </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearCommentAudio()" title="Remove audio file">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            <!-- Submit Button and Character Count -->
                            <div class="comment-input-footer">
                                    <small class="text-muted">
                                        <span id="charCount">0</span>/2200 characters
                                    </small>
                                <button class="btn btn-submit-comment" onclick="postComment()" id="postCommentBtn">
                                    Submit
                                    </button>
                                </div>
                            </div>

                            <!-- Comments List -->
                        <div class="comments-list-container">
                            <div id="commentsList">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                    <p>Loading comments...</p>
                                </div>
                            </div>

                            <!-- Load More -->
                            <div id="loadMoreContainer" class="text-center mt-3" style="display: none;">
                                <button class="btn btn-outline-primary btn-sm" onclick="loadMoreComments()" id="loadMoreBtn">
                                    <i class="fas fa-chevron-down me-1"></i>Load More Comments
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fixed Mobile Recording Panel -->
<div class="mobile-recording-panel d-md-none">
    <div class="mobile-panel-content">
        <!-- Recording Status -->
        <div class="mobile-recording-status" id="mobileRecordingStatus" style="display: none;">
            <i class="fas fa-circle recording-pulse"></i>
            <span id="mobileRecordingTimer">02:00</span>
        </div>
        
        <!-- Recording Buttons -->
        <div class="mobile-recording-buttons" id="mobileRecordingButtons">
            <button id="mobileRecordBtn" class="btn-mobile btn-mobile-record flex-fill" disabled style="opacity: 0.5;" title="Play the question audio first">
                <i class="fas fa-microphone me-1"></i> Record
            </button>
            <button id="mobileStopBtn" class="btn-mobile btn-mobile-stop flex-fill" disabled>
                <i class="fas fa-stop me-1"></i> Stop
            </button>
        </div>
        
        <!-- Playback Controls -->
        <div id="mobilePlaybackSection" style="display: none;">
            <div class="mobile-playback-buttons mb-2">
                <button id="mobilePlayBtn" class="btn-mobile-playback btn-mobile-play">
                    <i class="fas fa-play"></i>
                </button>
                <button id="mobilePauseBtn" class="btn-mobile-playback btn-mobile-pause" style="display: none;">
                    <i class="fas fa-pause"></i>
                </button>
                <button id="mobileDownloadBtn" class="btn-mobile-playback btn-mobile-download">
                    <i class="fas fa-download"></i>
                </button>
                <button id="mobileSubmitBtn" class="btn-mobile-submit flex-fill">
                    <i class="fas fa-paper-plane me-1"></i> Submit
                </button>
            </div>
            <div class="mobile-progress-bar">
                <input type="range" id="mobilePlaybackProgress" class="audio-progress-bar" min="0" max="100" value="0">
                <div class="audio-time">
                    <span id="mobilePlaybackCurrentTime">0:00</span> / <span id="mobilePlaybackDuration">0:00</span>
                </div>
            </div>
        </div>
        
        <!-- Audio Visualization -->
        <div class="mobile-audio-visualization" id="mobileAudioVisualization" style="display: none;">
            <canvas id="mobileAudioCanvas" width="300" height="30"></canvas>
        </div>
    </div>
</div>


<style>
/* Compact Layout - Fit everything on one page */
.sidebar {
    background-color: #f8f9fa;
    min-height: calc(100vh - 56px);
    padding: 1rem 1.25rem;
    border-right: 1px solid #dee2e6;
}

@media (max-width: 991px) {
    .sidebar {
        min-height: auto;
        padding: 1rem;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 1rem;
    }
}

[data-theme="dark"] .sidebar {
    background-color: var(--bg-secondary);
    border-right-color: var(--border-color);
}

.sidebar-content {
    position: sticky;
    top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

@media (max-width: 991px) {
    .sidebar-content {
        position: static;
    }
}

.sidebar-title {
    color: #495057;
    margin-bottom: 12px;
    font-weight: 600;
    font-size: 1.1rem;
}

.practice-section {
    margin-bottom: 0;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

[data-theme="dark"] .practice-section {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
}

.practice-section h5 {
    color: #495057;
    margin-bottom: 10px;
    font-weight: 600;
    font-size: 0.95rem;
}

.question-info {
    margin-top: 8px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    padding: 5px 0;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.9rem;
}

.info-label {
    color: #6c757d;
    font-weight: 500;
}

.info-value {
    color: #007bff;
    font-weight: 600;
}

.info-value.level-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3px 10px;
    border-radius: 5px;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-block {
    width: 100%;
    margin-bottom: 8px;
    padding: 8px;
    border-radius: 5px;
    font-weight: 500;
    font-size: 0.9rem;
}

.recording-status {
    margin-top: 10px;
    text-align: center;
}

.recording-status-inline {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #fff3cd;
    border-radius: 5px;
    margin: 10px 0;
}

.status-indicator {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}

.recording-pulse {
    color: #dc3545;
    animation: pulse 1s infinite;
    margin-right: 8px;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.recording-timer {
    font-size: 1.5rem;
    font-weight: 700;
    color: #dc3545;
    font-family: 'Courier New', monospace;
}

.recording-timer-inline {
    font-size: 1.2rem;
    font-weight: 700;
    color: #dc3545;
    font-family: 'Courier New', monospace;
}

.navigation-controls {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
}

.navigation-controls .btn {
    width: 100%;
    padding: 0.625rem 1rem;
    font-size: 0.9375rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

/* Main Content Styles - Compact */
.main-content {
    padding: 1rem 1.25rem;
    max-height: calc(100vh - 56px);
    overflow-y: auto;
}

@media (max-width: 768px) {
    .main-content {
        padding: 1rem;
        max-height: none;
    }
}

.question-container {
    max-width: 100%;
}

.question-header {
    text-align: center;
    margin-bottom: 15px;
}

.question-header h2 {
    color: #495057;
    margin-bottom: 5px;
    font-size: 1.5rem;
}

.question-subtitle {
    color: #6c757d;
    font-size: 0.95rem;
}

/* Question and Response Cards */
.question-card,
.response-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: box-shadow 0.3s ease;
}

.question-card:hover,
.response-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}

.card-section {
    padding: 20px 0;
}

.card-section:first-child {
    padding-top: 0;
}

.card-section:last-child {
    padding-bottom: 0;
}

.section-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #dee2e6, transparent);
    margin: 24px 0;
}

.section-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 16px;
    color: #2c3e50;
}

.section-title i {
    font-size: 1.25rem;
}

/* Audio Player */
.audio-player {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 10px;
    margin: 16px 0;
}

.btn-player {
    min-width: 120px;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
}

.player-progress {
    flex: 1;
    min-width: 0;
}

.progress-slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
    background: #dee2e6;
    margin-bottom: 4px;
}

.progress-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #0d6efd;
    cursor: pointer;
}

.progress-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #0d6efd;
    cursor: pointer;
    border: none;
}

.time-display {
    font-size: 0.85rem;
    color: #6c757d;
    text-align: center;
}

/* Toggle Buttons - Unified Style */
.btn-toggle-text,
.btn-show-hide {
    padding: 10px 16px;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-weight: 500;
    color: #495057;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
}

.btn-toggle-text {
    width: 100%;
    justify-content: center;
}

.btn-show-hide {
    padding: 8px 14px;
}

.btn-toggle-text:hover,
.btn-show-hide:hover {
    background: #f8f9fa;
    border-color: #0d6efd;
    color: #0d6efd;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-toggle-text:active,
.btn-show-hide:active {
    transform: translateY(0);
}

/* Active/Opened state */
.btn-toggle-text.active,
.btn-show-hide.active {
    background: #e7f1ff;
    border-color: #0d6efd;
    color: #0d6efd;
}

.toggle-content {
    margin-top: 16px;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.warning-note {
    padding: 12px 16px;
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    border-radius: 6px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #856404;
}

.text-content,
.sample-answer-text {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    line-height: 1.8;
    color: #212529;
    font-size: 1rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

.sample-answer-text {
    border-left: 4px solid #ffc107;
}

/* Response Controls */
.response-controls {
    display: flex;
    gap: 12px;
    margin: 16px 0;
}

.btn-response {
    flex: 1;
    padding: 16px;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1.05rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-response:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.12);
}

.btn-response:active:not(:disabled) {
    transform: translateY(0);
}

.btn-record {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-record:hover:not(:disabled) {
    background: #ffe5e7;
    border-color: #bb2d3b;
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

.btn-stop {
    color: #6c757d;
    border-color: #6c757d;
}

.btn-stop:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #495057;
    box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
}

.btn-response:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Playback Actions Bar */
.playback-actions-bar {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 10px;
    margin: 16px 0;
}

.btn-playback {
    padding: 12px 16px;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.9rem;
    white-space: nowrap;
}

.btn-playback:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.btn-playback:active {
    transform: translateY(0);
}

.btn-play {
    color: #198754;
    border-color: #198754;
}

.btn-play:hover {
    background: #d1e7dd;
    border-color: #146c43;
}

.btn-pause {
    color: #fd7e14;
    border-color: #fd7e14;
}

.btn-pause:hover {
    background: #ffe5d0;
    border-color: #ca6510;
}

.btn-download {
    color: #0dcaf0;
    border-color: #0dcaf0;
}

.btn-download:hover {
    background: #cff4fc;
    border-color: #0aa2c0;
}

.btn-submit-response {
    padding: 12px 24px;
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.95rem;
    box-shadow: 0 2px 6px rgba(13, 110, 253, 0.3);
}

.btn-submit-response:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
    background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
}

.btn-submit-response:active {
    transform: translateY(0);
}

.recording-timer {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 16px;
    background: #dc3545;
    color: white;
    border-radius: 20px;
    font-weight: 600;
}

.pulse-animation {
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* Mobile Recording Panel */
.mobile-recording-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 2px solid #dee2e6;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
    z-index: 1040;
    padding: 12px;
}

.mobile-panel-content {
    max-width: 100%;
}

.mobile-recording-status {
    text-align: center;
    padding: 8px;
    background: #dc3545;
    color: white;
    border-radius: 6px;
    margin-bottom: 10px;
    font-weight: 600;
    font-size: 1.1rem;
}

.mobile-recording-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.btn-mobile {
    padding: 14px;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-mobile:active:not(:disabled) {
    transform: scale(0.98);
}

.btn-mobile-record {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-mobile-record:hover:not(:disabled) {
    background: #ffe5e7;
    border-color: #bb2d3b;
}

.btn-mobile-stop {
    color: #6c757d;
    border-color: #6c757d;
}

.btn-mobile-stop:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #495057;
}

.btn-mobile:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.mobile-playback-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
}

.btn-mobile-playback {
    padding: 10px;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    min-width: 44px;
    height: 44px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-mobile-playback:active {
    transform: scale(0.95);
}

.btn-mobile-play {
    color: #198754;
    border-color: #198754;
}

.btn-mobile-play:hover {
    background: #d1e7dd;
}

.btn-mobile-pause {
    color: #fd7e14;
    border-color: #fd7e14;
}

.btn-mobile-pause:hover {
    background: #ffe5d0;
}

.btn-mobile-download {
    color: #0dcaf0;
    border-color: #0dcaf0;
}

.btn-mobile-download:hover {
    background: #cff4fc;
}

.btn-mobile-submit {
    padding: 10px 20px;
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 2px 6px rgba(13, 110, 253, 0.3);
}

.btn-mobile-submit:active {
    transform: scale(0.98);
}

.mobile-progress-bar {
    margin-top: 8px;
}

.mobile-audio-visualization {
    text-align: center;
    padding: 10px 0;
}

.mobile-audio-visualization canvas {
    max-width: 100%;
    height: auto;
}

/* Add bottom padding to main content on mobile to account for fixed panel */
@media (max-width: 767px) {
    .main-content {
        padding-bottom: 140px !important;
    }
    
    .audio-controls-row {
        flex-wrap: wrap;
    }
    
    .audio-controls-row .btn {
        min-width: 120px;
    }
}

.question-audio, .question-text, .response-area, .sample-answer-section {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    margin-bottom: 15px;
}

/* Grouped Question & Sample Answer Section */
.question-sample-group.compact {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

.group-title {
    color: #495057;
    font-weight: 700;
    font-size: 1.1rem;
    border-bottom: 2px solid #007bff;
    padding-bottom: 8px;
    margin-bottom: 15px;
}

.subsection {
    background: white;
    padding: 12px;
    border-radius: 8px;
}

.subsection-title {
    color: #495057;
    font-weight: 600;
    font-size: 0.9rem;
}

.question-sample-group hr {
    border-top: 2px dashed #dee2e6;
    margin: 12px 0;
}

.question-audio.compact, .question-text.compact, .response-area.compact, .sample-answer-section.compact {
    padding: 10px;
    margin-bottom: 8px;
}

.response-area.compact {
    background: white;
    border: 2px solid #28a745;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

.section-title {
    color: #495057;
    margin-bottom: 0;
    font-weight: 600;
    font-size: 1rem;
}

h5.section-title {
    font-size: 0.95rem;
}

.question-audio h4, .question-text h4, .response-area h4 {
    color: #495057;
    margin-bottom: 12px;
    font-weight: 600;
    font-size: 1.1rem;
}

/* Audio Player Container - Compact */
.audio-player-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.audio-progress-wrapper {
    width: 100%;
}

.audio-progress-wrapper.compact {
    margin-top: 8px;
}

.audio-progress-bar {
    width: 100%;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: #dee2e6;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
}

.audio-progress-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    background: #007bff;
    border-radius: 50%;
    cursor: pointer;
}

.audio-progress-bar::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: #007bff;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

.audio-time {
    display: flex;
    justify-content: space-between;
    margin-top: 3px;
    font-size: 0.85rem;
    color: #6c757d;
}

/* Volume Control Styles */
.volume-control {
    display: flex;
    align-items: center;
    gap: 6px;
}

.volume-slider {
    width: 80px;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: #dee2e6;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    background: #6c757d;
    border-radius: 50%;
    cursor: pointer;
}

.volume-slider::-moz-range-thumb {
    width: 12px;
    height: 12px;
    background: #6c757d;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

.text-content {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 6px;
    border-left: 3px solid #007bff;
    font-size: 0.95rem;
    line-height: 1.5;
    color: #495057;
    max-height: 150px;
    overflow-y: auto;
}

#toggleTextBtn, #toggleSampleBtn {
    transition: all 0.2s ease;
    font-weight: 500;
}

#toggleTextBtn:hover, #toggleSampleBtn:hover {
    transform: translateY(-1px);
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffc107;
    color: #856404;
    padding: 8px 12px;
    font-size: 0.85rem;
}

/* Dark mode for main content areas */
[data-theme="dark"] .question-audio,
[data-theme="dark"] .question-text,
[data-theme="dark"] .response-area,
[data-theme="dark"] .sample-answer-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

[data-theme="dark"] .alert-warning {
    background-color: rgba(255, 193, 7, 0.2);
    border-color: rgba(255, 193, 7, 0.4);
    color: #ffc107;
}

[data-theme="dark"] .question-section h3,
[data-theme="dark"] .response-area h3,
[data-theme="dark"] .sample-answer-section h3 {
    color: var(--text-primary);
}

[data-theme="dark"] .question-text p {
    color: var(--text-primary);
}

[data-theme="dark"] .card {
    background: var(--bg-secondary);
    border-color: var(--border-color);
}

[data-theme="dark"] .card-body {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

[data-theme="dark"] .btn-outline-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: var(--border-color);
}

[data-theme="dark"] .btn-outline-secondary:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
    border-color: var(--border-color);
}

[data-theme="dark"] .sidebar-title,
[data-theme="dark"] .section-title,
[data-theme="dark"] .subsection-title {
    color: var(--text-primary);
}

[data-theme="dark"] .info-label {
    color: var(--text-secondary);
}

[data-theme="dark"] .info-value {
    color: var(--text-primary);
}

[data-theme="dark"] .level-badge {
    background: rgba(13, 110, 253, 0.2);
    color: #58a6ff;
    border-color: #58a6ff;
}

[data-theme="dark"] .practice-section,
[data-theme="dark"] .subsection {
    background: rgba(255, 255, 255, 0.03);
    border-color: var(--border-color);
}

[data-theme="dark"] hr {
    border-color: var(--border-color);
    opacity: 0.2;
}

[data-theme="dark"] .sample-text,
[data-theme="dark"] .text-display {
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.03);
    border-color: var(--border-color);
}

[data-theme="dark"] .card-header {
    background: var(--bg-secondary) !important;
    border-bottom-color: var(--border-color) !important;
    color: var(--text-primary) !important;
}

[data-theme="dark"] .form-control {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: var(--border-color);
}

[data-theme="dark"] .form-control:focus {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-color: #58a6ff;
    box-shadow: 0 0 0 0.25rem rgba(88, 166, 255, 0.25);
}

[data-theme="dark"] .form-label {
    color: var(--text-primary);
}

[data-theme="dark"] .text-muted {
    color: var(--text-muted) !important;
}

[data-theme="dark"] .btn-outline-info {
    color: #58a6ff;
    border-color: #58a6ff;
}

[data-theme="dark"] .btn-outline-info:hover {
    background: rgba(88, 166, 255, 0.1);
    color: #79c0ff;
    border-color: #79c0ff;
}

[data-theme="dark"] .btn-outline-warning {
    color: #ffc107;
    border-color: #ffc107;
}

[data-theme="dark"] .btn-outline-warning:hover {
    background: rgba(255, 193, 7, 0.1);
    color: #ffca2c;
    border-color: #ffca2c;
}

[data-theme="dark"] .btn-outline-primary {
    color: #58a6ff;
    border-color: #58a6ff;
}

[data-theme="dark"] .btn-outline-primary:hover {
    background: rgba(88, 166, 255, 0.1);
    color: #79c0ff;
    border-color: #79c0ff;
}

[data-theme="dark"] .audio-time {
    color: var(--text-secondary);
}

/* Dark mode styles */
[data-theme="dark"] .question-card,
[data-theme="dark"] .response-card {
    background: var(--bg-secondary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
}

[data-theme="dark"] .question-card:hover,
[data-theme="dark"] .response-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.7);
}

[data-theme="dark"] .section-title {
    color: var(--text-primary);
}

[data-theme="dark"] .section-divider {
    background: linear-gradient(90deg, transparent, var(--border-color), transparent);
}

[data-theme="dark"] .audio-player {
    background: rgba(255,255,255,0.05);
}

[data-theme="dark"] .btn-toggle-text,
[data-theme="dark"] .btn-show-hide {
    background: rgba(255,255,255,0.03);
    border-color: var(--border-color);
    color: var(--text-primary);
}

[data-theme="dark"] .btn-toggle-text:hover,
[data-theme="dark"] .btn-show-hide:hover {
    background: rgba(255,255,255,0.08);
    border-color: #58a6ff;
    color: #58a6ff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

[data-theme="dark"] .btn-toggle-text.active,
[data-theme="dark"] .btn-show-hide.active {
    background: rgba(88, 166, 255, 0.15);
    border-color: #58a6ff;
    color: #58a6ff;
}

[data-theme="dark"] .btn-playback {
    background: rgba(255,255,255,0.03);
    border-color: var(--border-color);
}

[data-theme="dark"] .btn-play {
    color: #4ade80;
    border-color: #4ade80;
}

[data-theme="dark"] .btn-play:hover {
    background: rgba(74, 222, 128, 0.15);
    border-color: #22c55e;
}

[data-theme="dark"] .btn-pause {
    color: #fb923c;
    border-color: #fb923c;
}

[data-theme="dark"] .btn-pause:hover {
    background: rgba(251, 146, 60, 0.15);
    border-color: #f97316;
}

[data-theme="dark"] .btn-download {
    color: #22d3ee;
    border-color: #22d3ee;
}

[data-theme="dark"] .btn-download:hover {
    background: rgba(34, 211, 238, 0.15);
    border-color: #06b6d4;
}

[data-theme="dark"] .btn-submit-response {
    background: linear-gradient(135deg, #58a6ff 0%, #388bfd 100%);
    box-shadow: 0 2px 6px rgba(88, 166, 255, 0.3);
}

[data-theme="dark"] .btn-submit-response:hover {
    background: linear-gradient(135deg, #388bfd 0%, #1f6feb 100%);
    box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
}

[data-theme="dark"] .btn-response {
    background: rgba(255,255,255,0.03);
    border-color: var(--border-color);
}

[data-theme="dark"] .btn-record {
    color: #f87171;
    border-color: #f87171;
}

[data-theme="dark"] .btn-record:hover:not(:disabled) {
    background: rgba(248, 113, 113, 0.15);
    border-color: #ef4444;
    box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3);
}

[data-theme="dark"] .btn-stop {
    color: #9ca3af;
    border-color: #9ca3af;
}

[data-theme="dark"] .btn-stop:hover:not(:disabled) {
    background: rgba(156, 163, 175, 0.15);
    border-color: #6b7280;
    box-shadow: 0 4px 8px rgba(156, 163, 175, 0.3);
}

[data-theme="dark"] .warning-note {
    background: rgba(255, 193, 7, 0.15);
    border-left-color: #ffc107;
    color: #ffc107;
}

[data-theme="dark"] .text-content,
[data-theme="dark"] .sample-answer-text {
    background: rgba(255,255,255,0.05);
    color: var(--text-primary);
}

[data-theme="dark"] .sample-answer-text {
    border-left-color: #ffc107;
}

[data-theme="dark"] .progress-slider {
    background: var(--border-color);
}

[data-theme="dark"] .progress-slider::-webkit-slider-thumb {
    background: #58a6ff;
}

[data-theme="dark"] .progress-slider::-moz-range-thumb {
    background: #58a6ff;
}

[data-theme="dark"] .time-display {
    color: var(--text-secondary);
}

[data-theme="dark"] .mobile-recording-panel {
    background: var(--bg-secondary);
    border-top-color: var(--border-color);
    box-shadow: 0 -4px 12px rgba(0,0,0,0.5);
}

[data-theme="dark"] .btn-mobile,
[data-theme="dark"] .btn-mobile-playback {
    background: rgba(255,255,255,0.03);
    border-color: var(--border-color);
}

[data-theme="dark"] .btn-mobile-record {
    color: #f87171;
    border-color: #f87171;
}

[data-theme="dark"] .btn-mobile-record:hover:not(:disabled) {
    background: rgba(248, 113, 113, 0.15);
    border-color: #ef4444;
}

[data-theme="dark"] .btn-mobile-stop {
    color: #9ca3af;
    border-color: #9ca3af;
}

[data-theme="dark"] .btn-mobile-stop:hover:not(:disabled) {
    background: rgba(156, 163, 175, 0.15);
    border-color: #6b7280;
}

[data-theme="dark"] .btn-mobile-play {
    color: #4ade80;
    border-color: #4ade80;
}

[data-theme="dark"] .btn-mobile-play:hover {
    background: rgba(74, 222, 128, 0.15);
}

[data-theme="dark"] .btn-mobile-pause {
    color: #fb923c;
    border-color: #fb923c;
}

[data-theme="dark"] .btn-mobile-pause:hover {
    background: rgba(251, 146, 60, 0.15);
}

[data-theme="dark"] .btn-mobile-download {
    color: #22d3ee;
    border-color: #22d3ee;
}

[data-theme="dark"] .btn-mobile-download:hover {
    background: rgba(34, 211, 238, 0.15);
}

[data-theme="dark"] .btn-mobile-submit {
    background: linear-gradient(135deg, #58a6ff 0%, #388bfd 100%);
    box-shadow: 0 2px 6px rgba(88, 166, 255, 0.3);
}

/* Mobile responsive styles */
@media (max-width: 767px) {
    .question-card,
    .response-card {
        padding: 16px;
        margin-bottom: 12px;
    }
    
    .section-title {
        font-size: 1rem;
    }
    
    .section-title span {
        font-size: 0.9rem;
    }
    
    .audio-player {
        padding: 12px;
        gap: 8px;
    }
    
    .btn-player {
        min-width: auto;
        padding: 10px 16px;
    }
    
    .response-controls {
        flex-direction: column;
    }
    
    .btn-response {
        width: 100%;
    }
    
    .playback-actions-bar {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .btn-playback,
    .btn-submit-response {
        width: 100%;
    }
    
    .btn-playback {
        padding: 10px 12px;
        font-size: 0.85rem;
    }
    
    .btn-playback span {
        display: none;
    }
    
    .btn-submit-response {
        grid-column: 1;
        justify-content: center;
        padding: 12px;
    }
    
    .btn-submit-response span {
        display: inline;
    }
    
    .btn-show-hide {
        font-size: 0.85rem;
        padding: 6px 10px;
    }
}

.audio-visualization {
    margin: 8px 0;
    text-align: center;
}

#audioCanvas {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: #f8f9fa;
    width: 100%;
    max-width: 600px;
    height: 60px;
}

/* Playback Controls - Compact */
.playback-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.playback-controls.compact {
    gap: 5px;
    margin-bottom: 8px;
}

.playback-controls.compact button {
    flex: 1;
    min-width: 70px;
}

.playback-progress-wrapper {
    margin-top: 10px;
}

/* Recording Buttons Inline */
.recording-buttons-inline {
    display: flex;
    gap: 8px;
}

.recording-buttons-inline .btn {
    flex: 1;
}

.recording-status-inline {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #fff3cd;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
}

.recording-pulse {
    color: #dc3545;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* Sample Answer Styles */
.sample-answer-section {
    border: 1px solid #17a2b8;
}

.sample-content {
    margin-top: 10px;
}

.sample-audio-player {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.sample-text {
    background: #e7f7ff;
    padding: 10px;
    border-radius: 5px;
    border-left: 3px solid #17a2b8;
    font-size: 0.9rem;
    line-height: 1.5;
    color: #495057;
    max-height: 120px;
    overflow-y: auto;
}

/* Mobile Responsive - Clean & Simple */
@media (max-width: 768px) {
    /* Hide sidebar on mobile */
    .sidebar {
        display: none !important;
    }
    
    /* Full width main content */
    .col-md-9 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .main-content {
        padding: 8px;
        max-height: none;
    }
    
    /* Mobile topic badge - simple and clean */
    .mobile-topic-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .badge-level {
        background: rgba(255, 255, 255, 0.3);
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: 700;
        margin-right: 6px;
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    
    /* Compact header */
    .question-header {
        margin-bottom: 8px;
    }
    
    .question-header h5 {
        font-size: 1rem;
        margin-bottom: 0;
    }
    
    /* Compact sections */
    .question-audio.compact, 
    .question-text.compact, 
    .response-area.compact, 
    .sample-answer-section.compact {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
    }
    
    /* Section titles */
    h5.section-title {
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    /* Buttons */
    .btn-sm {
        padding: 6px 10px;
        font-size: 0.85rem;
    }
    
    /* Audio controls */
    .audio-progress-wrapper.compact {
        margin-top: 6px;
    }
    
    .audio-time {
        font-size: 0.75rem;
        margin-top: 4px;
    }
    
    /* Audio visualization - smaller */
    .audio-visualization.compact {
        margin: 8px 0;
    }
    
    #audioCanvas {
        height: 35px;
        max-height: 35px;
    }
    
    /* Recording status */
    .recording-status-inline {
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    
    .recording-timer-inline {
        font-size: 0.9rem;
        font-weight: 700;
    }
    
    /* Recording buttons */
    .recording-buttons-inline {
        gap: 6px;
    }
    
    .recording-buttons-inline .btn {
        padding: 8px 12px;
        font-size: 0.85rem;
    }
    
    /* Playback controls */
    .playback-controls.compact {
        gap: 6px;
        margin-bottom: 6px;
    }
    
    .playback-controls.compact .btn {
        padding: 6px 8px;
        font-size: 0.8rem;
    }
    
    /* Text content areas - scrollable */
    .text-content, .sample-text {
        font-size: 0.85rem;
        line-height: 1.5;
        max-height: 150px;
        overflow-y: auto;
        padding: 10px;
    }
    
    .sample-text.compact {
        max-height: 150px;
    }
    
    .text-display {
        font-size: 0.85rem;
        line-height: 1.5;
    }
    
    /* Alerts */
    .alert-sm {
        padding: 6px 10px;
        font-size: 0.75rem;
        margin-bottom: 8px;
    }
    
    /* Comments section spacing */
    .comments-section {
        margin-top: 15px !important;
    }
    
    /* Add some bottom padding for easier scrolling */
    .question-container {
        padding-bottom: 20px;
    }
    
    /* Volume controls - hide slider on very small screens */
    .volume-slider {
        width: 60px;
    }
}

@media (max-width: 480px) {
    .volume-slider {
        width: 50px;
    }
}

/* Avatar Styles */
.comment-avatar {
    flex-shrink: 0;
    margin-right: 12px !important;
}

.avatar-img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #dee2e6;
    background: #f8f9fa;
    display: block;
}

.avatar-img-small {
    width: 36px;
    height: 36px;
    border: 2px solid #dee2e6;
}

[data-theme="dark"] .avatar-img {
    border-color: var(--border-color);
    background: var(--bg-secondary);
}

/* Modern Comment Card Styling */
.comment-card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    padding: 0;
    margin-bottom: 20px;
}

[data-theme="dark"] .comment-card {
    background: var(--bg-secondary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Comments Header */
.comments-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e8e8e8;
}

[data-theme="dark"] .comments-header {
    border-bottom-color: var(--border-color);
}

.comments-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

[data-theme="dark"] .comments-title {
    color: var(--text-color);
}

.comments-badge {
    background: #ff6b35;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
}

.comments-sort .form-select {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    padding: 6px 28px 6px 12px;
}

[data-theme="dark"] .comments-sort .form-select {
    background: var(--bg-primary);
    border-color: var(--border-color);
    color: var(--text-color);
}

/* Comment Input Area */
.comment-input-area {
    padding: 24px;
    border-bottom: 1px solid #e8e8e8;
}

[data-theme="dark"] .comment-input-area {
    border-bottom-color: var(--border-color);
}

.comment-textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px 16px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.comment-textarea:focus {
    outline: none;
    border-color: #ff6b35;
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
}

[data-theme="dark"] .comment-textarea {
    background: var(--bg-primary);
    border-color: var(--border-color);
    color: var(--text-color);
}

[data-theme="dark"] .comment-textarea:focus {
    background: var(--bg-secondary);
    border-color: #ff6b35;
}

/* Formatting Toolbar */
.formatting-toolbar {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
}

[data-theme="dark"] .formatting-toolbar {
    border-top-color: var(--border-color);
}

.format-btn {
    background: transparent;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    color: #666;
    font-size: 14px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}

.format-btn:hover {
    background: #f0f0f0;
    color: #333;
}

[data-theme="dark"] .format-btn {
    color: #aaa;
}

[data-theme="dark"] .format-btn:hover {
    background: var(--bg-secondary);
    color: var(--text-color);
}

.comment-input-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
}

.btn-submit-comment {
    background: #ff6b35;
    color: white;
    border: none;
    padding: 8px 24px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-submit-comment:hover {
    background: #e55a2b;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
}

.btn-submit-comment:active {
    transform: translateY(0);
}

/* Comments List Container */
.comments-list-container {
    padding: 24px;
}

/* Individual Comment Styling */
.comment {
    background: transparent;
    border: none;
    padding: 16px 0;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
}

.comment:last-child {
    border-bottom: none;
}

[data-theme="dark"] .comment {
    border-bottom-color: var(--border-color);
}

.comment:hover {
    background: transparent;
    box-shadow: none;
}

/* Comment Header Styling */
.comment-header {
    margin-bottom: 8px;
}

.comment-user-name {
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

[data-theme="dark"] .comment-user-name {
    color: var(--text-color);
}

.comment .text-muted {
    font-size: 13px;
}

.comment-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    margin-bottom: 12px;
}

[data-theme="dark"] .comment-content {
    color: #e0e0e0;
}

/* Comment actions (Like, Reply, Time) */
.comment-actions {
    font-size: 13px;
}

.comment-actions .btn {
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s ease;
}

/* Liked state - stays blue */
.comment-actions .btn.text-primary,
.comment-actions .btn.text-primary:hover {
    color: #0d6efd !important;
    font-weight: 600;
}

.comment-actions .btn.text-primary i,
.comment-actions .btn.text-primary:hover i {
    color: #0d6efd !important;
}

/* Hover effect for non-liked buttons */
.comment-actions .btn.text-muted:hover {
    color: #0d6efd !important;
}

.comment-actions .btn.text-muted:hover i {
    color: #0d6efd !important;
}

/* Dark theme */
[data-theme="dark"] .comment-actions .btn.text-primary,
[data-theme="dark"] .comment-actions .btn.text-primary:hover {
    color: #58a6ff !important;
}

[data-theme="dark"] .comment-actions .btn.text-primary i,
[data-theme="dark"] .comment-actions .btn.text-primary:hover i {
    color: #58a6ff !important;
}

[data-theme="dark"] .comment-actions .btn.text-muted:hover {
    color: #58a6ff !important;
}

[data-theme="dark"] .comment-actions .btn.text-muted:hover i {
    color: #58a6ff !important;
}

/* Audio Upload UI */
.audio-upload-container {
    position: relative;
}

.audio-upload-btn {
    transition: all 0.2s ease;
    border: 2px dashed #dee2e6;
    background: #f8f9fa;
}

.audio-upload-btn:hover {
    border-color: #0d6efd;
    background: #e7f1ff;
    color: #0d6efd;
}

[data-theme="dark"] .audio-upload-btn {
    background: var(--bg-secondary);
    border-color: var(--border-color);
    color: var(--text-color);
}

[data-theme="dark"] .audio-upload-btn:hover {
    border-color: #58a6ff;
    background: rgba(88, 166, 255, 0.1);
    color: #58a6ff;
}

#commentAudioPreview, .audio-preview {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Audio player in comments */
.audio-player-wrapper {
    margin-top: 8px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.comment-audio-player {
    width: 100%;
    max-width: 500px;
    height: 40px;
    outline: none;
}

.comment-audio-player::-webkit-media-controls-panel {
    background-color: #f8f9fa;
}

[data-theme="dark"] .audio-player-wrapper {
    background: var(--bg-secondary);
    border-color: var(--border-color);
}

[data-theme="dark"] .comment-audio-player::-webkit-media-controls-panel {
    background-color: var(--bg-secondary);
}

/* Audio preview styling */
#commentAudioPreview .bg-light,
.audio-preview .bg-light {
    transition: all 0.2s ease;
}

[data-theme="dark"] #commentAudioPreview .bg-light,
[data-theme="dark"] .audio-preview .bg-light {
    background: var(--bg-secondary) !important;
    border: 1px solid var(--border-color);
}

/* Reply Styling */
.replies-container {
    margin-left: 48px;
    margin-top: 16px;
    padding-left: 16px;
    border-left: 2px solid #e0e0e0;
    position: relative;
}

[data-theme="dark"] .replies-container {
    border-left-color: var(--border-color);
}

.reply {
    position: relative;
    padding: 12px 0;
    margin-bottom: 12px;
    background: transparent;
}

.reply:last-child {
    margin-bottom: 0;
}

.reply-connector {
    position: absolute;
    left: -18px;
    top: 24px;
    width: 12px;
    height: 2px;
    background: #e0e0e0;
}

[data-theme="dark"] .reply-connector {
    background: var(--border-color);
}

[data-theme="dark"] .reply {
    background: transparent;
}

/* Mobile responsive for avatars */
@media (max-width: 768px) {
    .avatar-img {
        width: 40px;
        height: 40px;
    }
    
    .avatar-img-small {
        width: 32px;
        height: 32px;
    }
    
    .comment-avatar {
        margin-right: 10px !important;
    }
    
    .comment strong {
        font-size: 14px;
    }
    
    .comment .text-muted {
        font-size: 12px;
    }
}

/* Auto-resize textarea */
.auto-resize-textarea {
    resize: none;
    overflow-y: hidden;
    transition: height 0.1s ease;
    min-height: 80px;
    max-height: 400px;
}

/* Mention autocomplete dropdown */
.mention-dropdown {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    min-width: 200px;
}

[data-theme="dark"] .mention-dropdown {
    background: var(--bg-secondary);
    border-color: var(--border-color);
}

.mention-item {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background-color 0.2s;
}

.mention-item:hover,
.mention-item.selected {
    background-color: #f0f0f0;
}

[data-theme="dark"] .mention-item:hover,
[data-theme="dark"] .mention-item.selected {
    background-color: rgba(255,255,255,0.1);
}

.mention-item-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #dee2e6;
}

.mention-item-info {
    display: flex;
    flex-direction: column;
}

.mention-item-name {
    font-weight: 600;
    font-size: 14px;
}

.mention-item-username {
    font-size: 12px;
    color: #6c757d;
}

/* Mention styling in comments */
.mention {
    color: #0d6efd;
    font-weight: 600;
    background-color: rgba(13, 110, 253, 0.1);
    padding: 2px 4px;
    border-radius: 3px;
    text-decoration: none;
    cursor: pointer;
}

.mention:hover {
    background-color: rgba(13, 110, 253, 0.2);
    text-decoration: underline;
}

[data-theme="dark"] .mention {
    color: #6ea8fe;
    background-color: rgba(110, 168, 254, 0.15);
}

[data-theme="dark"] .mention:hover {
    background-color: rgba(110, 168, 254, 0.25);
}
</style>

<script>
// Global variables
let mediaRecorder;
let audioChunks = [];
let recordedBlob;
let recordingStartTime;
let recordingTimer;
let recordingTimeLeft = 120; // 2 minutes in seconds
const MAX_RECORDING_TIME = 120; // 2 minutes

// Speech Recognition for automatic transcription
let recognition = null;
let transcriptionText = '';
let isTranscribing = false;

// Initialize Speech Recognition if available
function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true; // Keep listening during entire recording
        recognition.interimResults = true; // Show interim results
        recognition.lang = 'en-US';
        
        recognition.onresult = function(event) {
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }
            
            transcriptionText += finalTranscript;
            
            // Update transcript display if element exists
            const transcriptElement = document.getElementById('liveTranscript');
            if (transcriptElement) {
                transcriptElement.textContent = transcriptionText + interimTranscript;
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            if (event.error === 'no-speech') {
                // Normal - just no speech detected yet
            } else if (event.error === 'aborted') {
                // User stopped or navigation
            } else {
                console.warn('Transcription error:', event.error);
            }
        };
        
        recognition.onend = function() {
            // Auto-restart if we're still recording
            if (isTranscribing && mediaRecorder && mediaRecorder.state === 'recording') {
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Could not restart recognition:', e);
                }
            }
        };
    }
}

// Audio context for visualization
let audioContext;
let analyser;
let microphone;
let dataArray;

// Audio elements
const questionAudio = new Audio('/uploads/{{ question.audio_url or "" }}');
let playbackAudio;
let sampleAudio;
let sampleAnswerData = null;

// DOM elements
const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const downloadBtn = document.getElementById('downloadBtn');
const submitBtn = document.getElementById('submitBtn');
const playQuestionBtn = document.getElementById('playQuestionBtn');
const recordingStatusInline = document.getElementById('recordingStatusInline');
const recordingTimerInlineEl = document.getElementById('recordingTimerInline');
const audioVisualization = document.getElementById('audioVisualization');
const audioCanvas = document.getElementById('audioCanvas');
const playbackSection = document.getElementById('playbackSection');

// Question audio progress
const questionProgress = document.getElementById('questionProgress');
const currentTimeEl = document.getElementById('currentTime');
const durationEl = document.getElementById('duration');

// Playback progress
const playbackProgress = document.getElementById('playbackProgress');
const playbackCurrentTimeEl = document.getElementById('playbackCurrentTime');
const playbackDurationEl = document.getElementById('playbackDuration');

// Event listeners
// Initialize speech recognition on page load
initSpeechRecognition();

recordBtn.addEventListener('click', startRecording);
stopBtn.addEventListener('click', stopRecording);
playBtn.addEventListener('click', playRecording);
pauseBtn.addEventListener('click', pauseRecording);
downloadBtn.addEventListener('click', downloadRecording);
submitBtn.addEventListener('click', submitResponse);
playQuestionBtn.addEventListener('click', toggleQuestionAudio);

// Mobile recording buttons
const mobileRecordBtn = document.getElementById('mobileRecordBtn');
const mobileStopBtn = document.getElementById('mobileStopBtn');
const mobilePlayBtn = document.getElementById('mobilePlayBtn');
const mobilePauseBtn = document.getElementById('mobilePauseBtn');
const mobileDownloadBtn = document.getElementById('mobileDownloadBtn');
const mobileSubmitBtn = document.getElementById('mobileSubmitBtn');

if (mobileRecordBtn) mobileRecordBtn.addEventListener('click', startRecording);
if (mobileStopBtn) mobileStopBtn.addEventListener('click', stopRecording);
if (mobilePlayBtn) mobilePlayBtn.addEventListener('click', playRecording);
if (mobilePauseBtn) mobilePauseBtn.addEventListener('click', pauseRecording);
if (mobileDownloadBtn) mobileDownloadBtn.addEventListener('click', downloadRecording);
if (mobileSubmitBtn) mobileSubmitBtn.addEventListener('click', submitResponse);

// Question audio events
questionAudio.addEventListener('loadedmetadata', () => {
    durationEl.textContent = formatTime(questionAudio.duration);
    questionProgress.max = questionAudio.duration;
});

questionAudio.addEventListener('timeupdate', () => {
    questionProgress.value = questionAudio.currentTime;
    currentTimeEl.textContent = formatTime(questionAudio.currentTime);
});

questionAudio.addEventListener('ended', () => {
    playQuestionBtn.innerHTML = '<i class="fas fa-play"></i>';
});

questionProgress.addEventListener('input', () => {
    questionAudio.currentTime = questionProgress.value;
});

// Volume controls
const volumeQuestion = document.getElementById('volumeQuestion');
const volumeSample = document.getElementById('volumeSample');
const volumePlayback = document.getElementById('volumePlayback');

// Set initial volume
questionAudio.volume = 1.0;

// Question audio volume control
volumeQuestion.addEventListener('input', (e) => {
    const volume = e.target.value / 100;
    questionAudio.volume = volume;
    updateVolumeIcon('question', volume);
});

// Sample audio volume control (will be attached when sample audio is loaded)
volumeSample.addEventListener('input', (e) => {
    const volume = e.target.value / 100;
    if (sampleAudio) {
        sampleAudio.volume = volume;
        updateVolumeIcon('sample', volume);
    }
});

// Playback audio volume control (will be attached when playback audio is created)
volumePlayback.addEventListener('input', (e) => {
    const volume = e.target.value / 100;
    if (playbackAudio) {
        playbackAudio.volume = volume;
        updateVolumeIcon('playback', volume);
    }
});

// Update volume icon based on volume level
function updateVolumeIcon(type, volume) {
    const btn = document.getElementById(`volumeBtn${type.charAt(0).toUpperCase() + type.slice(1)}`);
    const icon = btn.querySelector('i');
    
    if (volume === 0) {
        icon.className = 'fas fa-volume-mute';
    } else if (volume < 0.5) {
        icon.className = 'fas fa-volume-down';
    } else {
        icon.className = 'fas fa-volume-up';
    }
}

// Toggle mute function
function toggleMute(type) {
    let audio, volumeSlider, volumeBtn;
    
    switch(type) {
        case 'question':
            audio = questionAudio;
            volumeSlider = volumeQuestion;
            volumeBtn = document.getElementById('volumeBtnQuestion');
            break;
        case 'sample':
            audio = sampleAudio;
            volumeSlider = volumeSample;
            volumeBtn = document.getElementById('volumeBtnSample');
            break;
        case 'playback':
            audio = playbackAudio;
            volumeSlider = volumePlayback;
            volumeBtn = document.getElementById('volumeBtnPlayback');
            break;
    }
    
    if (!audio) return;
    
    const icon = volumeBtn.querySelector('i');
    
    if (audio.volume > 0) {
        // Store current volume and mute
        audio.dataset.previousVolume = audio.volume;
        audio.volume = 0;
        volumeSlider.value = 0;
        icon.className = 'fas fa-volume-mute';
    } else {
        // Restore previous volume or set to 100%
        const previousVolume = audio.dataset.previousVolume || 1.0;
        audio.volume = previousVolume;
        volumeSlider.value = previousVolume * 100;
        updateVolumeIcon(type, previousVolume);
    }
}

// Functions
function toggleQuestionText() {
    const textContent = document.getElementById('questionTextContent');
    const toggleBtn = document.getElementById('toggleTextBtn');
    
    if (textContent.style.display === 'none') {
        // Show text
        textContent.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i><span>Hide Question Text</span>';
        toggleBtn.classList.add('active');
    } else {
        // Hide text
        textContent.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-eye"></i><span>Show Question Text</span>';
        toggleBtn.classList.remove('active');
    }
}

function toggleQuestionAudio() {
    if (questionAudio.paused) {
        questionAudio.play();
        playQuestionBtn.innerHTML = '<i class="fas fa-pause"></i>';
        
        // Enable recording button after first play
        if (!hasPlayedAudio) {
            hasPlayedAudio = true;
            recordBtn.disabled = false;
            recordBtn.style.opacity = '1';
            recordBtn.style.cursor = 'pointer';
            recordBtn.title = 'Record your response';
            if (mobileRecordBtn) {
                mobileRecordBtn.disabled = false;
                mobileRecordBtn.style.opacity = '1';
            }
            
            // Hide warning message
            const recordWarning = document.getElementById('recordWarning');
            if (recordWarning) {
                recordWarning.style.display = 'none';
            }
            
            // Show brief success message
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 10px 20px; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            notification.innerHTML = '<i class="fas fa-check-circle me-2"></i>Recording enabled! You can now record your answer.';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    } else {
        questionAudio.pause();
        playQuestionBtn.innerHTML = '<i class="fas fa-play"></i>';
    }
}

// Track if audio has been played
let hasPlayedAudio = false;

async function startRecording() {
    // Check if user has played the audio first
    if (!hasPlayedAudio) {
        alert(' Please listen to the question first before recording your response.');
        return;
    }
    
    try {
        // If re-recording, stop and cleanup existing playback
        if (playbackAudio) {
            playbackAudio.pause();
            playbackAudio = null;
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        recordingTimeLeft = MAX_RECORDING_TIME;
        
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
            showPlaybackControls();
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        
        // Start automatic transcription if available
        if (recognition && !isTranscribing) {
            transcriptionText = ''; // Reset transcript for new recording
            isTranscribing = true;
            try {
                recognition.start();
                // Show transcription indicator and container
                const transcriptIndicator = document.getElementById('transcriptIndicator');
                const transcriptContainer = document.getElementById('transcriptContainer');
                if (transcriptIndicator) {
                    transcriptIndicator.style.display = 'block';
                }
                if (transcriptContainer) {
                    transcriptContainer.style.display = 'block';
                }
            } catch (e) {
                console.log('Could not start transcription:', e);
            }
        }
        
        // Update UI
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        recordingStatusInline.style.display = 'flex';
        audioVisualization.style.display = 'block';
        
        // Update mobile buttons
        if (mobileRecordBtn) mobileRecordBtn.disabled = true;
        if (mobileStopBtn) mobileStopBtn.disabled = false;
        const mobileRecordingStatus = document.getElementById('mobileRecordingStatus');
        const mobileRecordingButtons = document.getElementById('mobileRecordingButtons');
        const mobileAudioVisualization = document.getElementById('mobileAudioVisualization');
        if (mobileRecordingStatus) mobileRecordingStatus.style.display = 'block';
        if (mobileAudioVisualization) mobileAudioVisualization.style.display = 'block';
        
        // Start countdown timer
        updateCountdownTimer();
        recordingTimer = setInterval(updateCountdownTimer, 1000);
        
        // Start audio visualization
        startAudioVisualization(stream);
        
    } catch (error) {
        console.error('Error starting recording:', error);
        
        let errorMessage = 'Unable to access microphone.\n\n';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage += 'Permission denied. Please:\n';
            errorMessage += '1. Click the lock/camera icon in the address bar\n';
            errorMessage += '2. Allow microphone access for this site\n';
            errorMessage += '3. Refresh the page and try again';
        } else if (error.name === 'NotFoundError') {
            errorMessage += 'No microphone found. Please connect a microphone and try again.';
        } else {
            errorMessage += 'Error: ' + error.message + '\n\n';
            errorMessage += 'Please check your browser settings and allow microphone access.';
        }
        
        alert(errorMessage);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        
        // Stop transcription
        if (recognition && isTranscribing) {
            isTranscribing = false;
            try {
                recognition.stop();
            } catch (e) {
                console.log('Error stopping recognition:', e);
            }
            
            // Hide transcription indicator and container
            const transcriptIndicator = document.getElementById('transcriptIndicator');
            const transcriptContainer = document.getElementById('transcriptContainer');
            if (transcriptIndicator) {
                transcriptIndicator.style.display = 'none';
            }
            if (transcriptContainer) {
                transcriptContainer.style.display = 'none';
            }
        }
        
        // Update UI
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        recordingStatusInline.style.display = 'none';
        audioVisualization.style.display = 'none';
        
        // Update mobile buttons - keep them visible for re-recording
        if (mobileRecordBtn) mobileRecordBtn.disabled = false;
        if (mobileStopBtn) mobileStopBtn.disabled = true;
        const mobileRecordingStatus = document.getElementById('mobileRecordingStatus');
        const mobileAudioVisualization = document.getElementById('mobileAudioVisualization');
        if (mobileRecordingStatus) mobileRecordingStatus.style.display = 'none';
        if (mobileAudioVisualization) mobileAudioVisualization.style.display = 'none';
        // Don't hide the recording buttons - user can record again
        
        // Stop timer
        clearInterval(recordingTimer);
        
        // Stop audio visualization
        if (audioContext) {
            audioContext.close();
        }
    }
}

function updateCountdownTimer() {
    recordingTimeLeft--;
    
    const minutes = Math.floor(recordingTimeLeft / 60);
    const seconds = recordingTimeLeft % 60;
    const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    recordingTimerInlineEl.textContent = timeStr;
    
    // Update mobile timer
    const mobileRecordingTimer = document.getElementById('mobileRecordingTimer');
    if (mobileRecordingTimer) {
        mobileRecordingTimer.textContent = timeStr;
    }
    
    // Auto-stop when time is up
    if (recordingTimeLeft <= 0) {
        stopRecording();
        alert('Recording time limit reached (2 minutes). Your response has been saved.');
    }
}

function showPlaybackControls() {
    playbackSection.style.display = 'block';
    
    // Show mobile playback section
    const mobilePlaybackSection = document.getElementById('mobilePlaybackSection');
    if (mobilePlaybackSection) {
        mobilePlaybackSection.style.display = 'block';
    }
    
    // Keep recording buttons visible and enabled for re-recording
    const mobileRecordingButtons = document.getElementById('mobileRecordingButtons');
    if (mobileRecordingButtons) {
        mobileRecordingButtons.style.display = 'flex';
    }
    
    // Reset button states
    playBtn.style.display = 'block';
    pauseBtn.style.display = 'none';
    if (mobilePlayBtn) mobilePlayBtn.style.display = 'block';
    if (mobilePauseBtn) mobilePauseBtn.style.display = 'none';
    
    // Create playback audio element
    playbackAudio = new Audio();
    playbackAudio.src = URL.createObjectURL(recordedBlob);
    
    // Set initial volume
    playbackAudio.volume = volumePlayback.value / 100;
    
    playbackAudio.addEventListener('loadedmetadata', () => {
        playbackDurationEl.textContent = formatTime(playbackAudio.duration);
        playbackProgress.max = playbackAudio.duration;
        
        // Update mobile duration
        const mobilePlaybackDuration = document.getElementById('mobilePlaybackDuration');
        if (mobilePlaybackDuration) {
            mobilePlaybackDuration.textContent = formatTime(playbackAudio.duration);
        }
        const mobilePlaybackProgress = document.getElementById('mobilePlaybackProgress');
        if (mobilePlaybackProgress) {
            mobilePlaybackProgress.max = playbackAudio.duration;
        }
    });
    
    playbackAudio.addEventListener('timeupdate', () => {
        playbackProgress.value = playbackAudio.currentTime;
        playbackCurrentTimeEl.textContent = formatTime(playbackAudio.currentTime);
        
        // Update mobile time
        const mobilePlaybackCurrentTime = document.getElementById('mobilePlaybackCurrentTime');
        const mobilePlaybackProgress = document.getElementById('mobilePlaybackProgress');
        if (mobilePlaybackCurrentTime) {
            mobilePlaybackCurrentTime.textContent = formatTime(playbackAudio.currentTime);
        }
        if (mobilePlaybackProgress) {
            mobilePlaybackProgress.value = playbackAudio.currentTime;
        }
    });
    
    playbackAudio.addEventListener('ended', () => {
        playBtn.style.display = 'block';
        pauseBtn.style.display = 'none';
        if (mobilePlayBtn) mobilePlayBtn.style.display = 'block';
        if (mobilePauseBtn) mobilePauseBtn.style.display = 'none';
    });
}

// ============================================================================
// SAMPLE ANSWER FUNCTIONALITY
// ============================================================================

// Load sample answers data
// Toggle sample answer visibility
function toggleSampleAnswer() {
    const content = document.getElementById('sampleAnswerContent');
    const btn = document.getElementById('toggleSampleBtn');
    const icon = btn.querySelector('i');
    const text = btn.querySelector('span');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
        text.textContent = 'Hide';
        btn.classList.add('active');
        
        // Display sample answer (data from database)
        displaySampleAnswer();
    } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
        text.textContent = 'Show';
        btn.classList.remove('active');
        
        // Stop sample audio if playing
        if (sampleAudio && !sampleAudio.paused) {
            sampleAudio.pause();
            sampleAudio.currentTime = 0;
            document.getElementById('playSampleBtn').innerHTML = '<i class="fas fa-play"></i><span class="d-none d-sm-inline ms-2"></span>';
        }
    }
}

// Display sample answer for current question
function displaySampleAnswer() {
    const sampleTextEl = document.getElementById('sampleAnswerText');
    
    // Get sample answer data from the template (passed from database)
    // Decode HTML entities - use template filter to decode, then escape for JavaScript
    const sampleAnswerText = {{ (question.sample_answer_text|unescape_html|tojson)|safe if question.sample_answer_text else '""' }};
    const sampleAnswerAudio = `{{ question.sample_answer_audio_url or '' }}`;
    
    console.log('Sample answer text:', sampleAnswerText ? 'Available' : 'Not available');
    console.log('Sample answer audio:', sampleAnswerAudio);
    
    if (sampleAnswerText && sampleAnswerText.trim() !== '') {
        // Display transcription
        sampleTextEl.textContent = sampleAnswerText;
        
        // Setup audio player if audio is available
        if (sampleAnswerAudio && sampleAnswerAudio.trim() !== '') {
            const sampleAudioPath = '/' + sampleAnswerAudio;
            sampleAudio = new Audio(sampleAudioPath);
            
            // Set initial volume
            sampleAudio.volume = volumeSample.value / 100;
            
            const sampleProgress = document.getElementById('sampleProgress');
            const sampleCurrentTimeEl = document.getElementById('sampleCurrentTime');
            const sampleDurationEl = document.getElementById('sampleDuration');
            const playSampleBtn = document.getElementById('playSampleBtn');
            
            sampleAudio.addEventListener('loadedmetadata', () => {
                sampleDurationEl.textContent = formatTime(sampleAudio.duration);
                sampleProgress.max = sampleAudio.duration;
            });
            
            sampleAudio.addEventListener('timeupdate', () => {
                sampleProgress.value = sampleAudio.currentTime;
                sampleCurrentTimeEl.textContent = formatTime(sampleAudio.currentTime);
            });
            
            sampleAudio.addEventListener('ended', () => {
                playSampleBtn.innerHTML = '<i class="fas fa-play"></i><span class="d-none d-sm-inline ms-2"></span>';
            });
            
            playSampleBtn.onclick = () => {
                if (sampleAudio.paused) {
                    sampleAudio.play();
                    playSampleBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    sampleAudio.pause();
                    playSampleBtn.innerHTML = '<i class="fas fa-play"></i><span class="d-none d-sm-inline ms-2"></span>';
                }
            };
            
            sampleProgress.addEventListener('input', () => {
                sampleAudio.currentTime = sampleProgress.value;
            });
        } else {
            console.warn('No audio file available for this answer');
        }
    } else {
        console.warn('No sample answer available for this question');
        sampleTextEl.innerHTML = '<em class="text-muted">No sample answer available for this question.</em>';
    }
}

function playRecording() {
    if (playbackAudio) {
        playbackAudio.play();
        playBtn.style.display = 'none';
        pauseBtn.style.display = 'block';
        
        // Update mobile buttons
        if (mobilePlayBtn) mobilePlayBtn.style.display = 'none';
        if (mobilePauseBtn) mobilePauseBtn.style.display = 'block';
    }
}

function pauseRecording() {
    if (playbackAudio) {
        playbackAudio.pause();
        playBtn.style.display = 'block';
        pauseBtn.style.display = 'none';
        
        // Update mobile buttons
        if (mobilePlayBtn) mobilePlayBtn.style.display = 'block';
        if (mobilePauseBtn) mobilePauseBtn.style.display = 'none';
    }
}

playbackProgress.addEventListener('input', () => {
    if (playbackAudio) {
        playbackAudio.currentTime = playbackProgress.value;
    }
});

// Mobile playback progress slider
const mobilePlaybackProgressSlider = document.getElementById('mobilePlaybackProgress');
if (mobilePlaybackProgressSlider) {
    mobilePlaybackProgressSlider.addEventListener('input', () => {
        if (playbackAudio) {
            playbackAudio.currentTime = mobilePlaybackProgressSlider.value;
        }
    });
}

function downloadRecording() {
    if (recordedBlob) {
        // Convert to WAV or MP3 format would be ideal, but browsers support WebM natively
        // Create a more user-friendly filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const url = URL.createObjectURL(recordedBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `OPIc_Practice_Response_${timestamp}.webm`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        
        // Show confirmation
        alert('Recording downloaded successfully!\n\nNote: The file is in WebM format, which is compatible with most modern media players.');
    } else {
        alert('No recording available to download. Please record your response first.');
    }
}

async function submitResponse() {
    if (!recordedBlob) {
        alert('Please record your response first.');
        return;
    }
    
    // Disable submit button to prevent double submission
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    try {
        const formData = new FormData();
        const file = new File([recordedBlob], 'response.webm', { type: 'audio/webm' });
        formData.append('audio', file);
        
        // Include transcript if available
        if (transcriptionText && transcriptionText.trim()) {
            formData.append('transcript', transcriptionText.trim());
        }
        
        // Show loading indicator
        const submitBtn = document.querySelector('button[onclick*="submitRecording"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
        }
        
        const response = await fetch('{{ url_for("practice_mode.record_practice_response", question_id=question.id) }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Redirect to congratulations page
            window.location.href = data.redirect_url;
        } else {
            throw new Error(data.error || 'Failed to submit response');
        }
    } catch (error) {
        console.error('Error submitting response:', error);
        alert('Error submitting response: ' + error.message);
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Response';
    }
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Audio visualization
function startAudioVisualization(stream) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    microphone = audioContext.createMediaStreamSource(stream);
    
    microphone.connect(analyser);
    analyser.fftSize = 256;
    
    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    
    draw();
}

function draw() {
    if (!analyser) return;
    
    requestAnimationFrame(draw);
    
    analyser.getByteFrequencyData(dataArray);
    
    // Draw on desktop canvas
    const canvas = audioCanvas;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(0, 0, width, height);
    
    const barWidth = (width / dataArray.length) * 2.5;
    let barHeight;
    
    let x = 0;
    
    for (let i = 0; i < dataArray.length; i++) {
        barHeight = (dataArray[i] / 255) * height;
        
        ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
        ctx.fillRect(x, height - barHeight, barWidth, barHeight);
        
        x += barWidth + 1;
    }
    
    // Draw on mobile canvas
    const mobileCanvas = document.getElementById('mobileAudioCanvas');
    if (mobileCanvas && mobileCanvas.offsetParent !== null) {
        const mobileCtx = mobileCanvas.getContext('2d');
        const mobileWidth = mobileCanvas.width;
        const mobileHeight = mobileCanvas.height;
        
        mobileCtx.fillStyle = '#f8f9fa';
        mobileCtx.fillRect(0, 0, mobileWidth, mobileHeight);
        
        const mobileBarWidth = (mobileWidth / dataArray.length) * 2.5;
        let mobilex = 0;
        
        for (let i = 0; i < dataArray.length; i++) {
            const mobileBarHeight = (dataArray[i] / 255) * mobileHeight;
            
            mobileCtx.fillStyle = `rgb(${mobileBarHeight + 100}, 50, 50)`;
            mobileCtx.fillRect(mobilex, mobileHeight - mobileBarHeight, mobileBarWidth, mobileBarHeight);
            
            mobilex += mobileBarWidth + 1;
        }
    }
}

// ============================================================================
// COMMENTS SYSTEM
// ============================================================================

const questionId = {{ question.id }};
let currentPage = 1;
let currentSort = 'recent';
let hasMoreComments = false;

// Store available users for mentions
let availableUsers = new Map();

// Auto-resize textarea function
function autoResizeTextarea(textarea) {
    // Reset height to auto to get the correct scrollHeight
    textarea.style.height = 'auto';
    
    // Set new height based on content, with min and max constraints
    const newHeight = Math.min(Math.max(textarea.scrollHeight, 80), 400);
    textarea.style.height = newHeight + 'px';
    
    // Show scrollbar if content exceeds max height
    if (textarea.scrollHeight > 400) {
        textarea.style.overflowY = 'auto';
    } else {
        textarea.style.overflowY = 'hidden';
    }
}

// Add user to available mentions
function addUserToMentions(userId, username, name, avatar) {
    if (!availableUsers.has(userId)) {
        availableUsers.set(userId, { username, name, avatar });
    }
}

// Parse mentions in text and convert to HTML
function parseMentions(text) {
    // Replace @username with styled mentions (supports dots, underscores, hyphens)
    return text.replace(/@([\w.-]+)/g, (match, username) => {
        return `<span class="mention" title="@${username}">@${username}</span>`;
    });
}

// Mention autocomplete functionality
class MentionAutocomplete {
    constructor(textarea, dropdownId) {
        this.textarea = textarea;
        this.dropdown = document.getElementById(dropdownId);
        this.selectedIndex = 0;
        this.filteredUsers = [];
        this.mentionStart = -1;
        this.isActive = false;
        
        this.setupListeners();
    }
    
    setupListeners() {
        this.textarea.addEventListener('input', (e) => this.handleInput(e));
        this.textarea.addEventListener('keydown', (e) => this.handleKeydown(e));
        document.addEventListener('click', (e) => {
            if (!this.dropdown.contains(e.target) && e.target !== this.textarea) {
                this.hide();
            }
        });
    }
    
    handleInput(e) {
        const value = this.textarea.value;
        const cursorPos = this.textarea.selectionStart;
        
        // Find @ symbol before cursor
        let atPos = -1;
        for (let i = cursorPos - 1; i >= 0; i--) {
            if (value[i] === '@') {
                // Check if @ is at start or after space/newline
                if (i === 0 || /\s/.test(value[i - 1])) {
                    atPos = i;
                    break;
                }
            } else if (/\s/.test(value[i])) {
                break;
            } else if (!/[\w.-]/.test(value[i])) {
                // Stop if character is not a valid username character
                break;
            }
        }
        
        if (atPos !== -1) {
            const searchTerm = value.substring(atPos + 1, cursorPos).toLowerCase();
            this.mentionStart = atPos;
            this.showSuggestions(searchTerm);
        } else {
            this.hide();
        }
    }
    
    showSuggestions(searchTerm) {
        // Filter users based on search term
        this.filteredUsers = Array.from(availableUsers.entries())
            .filter(([_, user]) => 
                user.username.toLowerCase().includes(searchTerm) ||
                user.name.toLowerCase().includes(searchTerm)
            )
            .slice(0, 5); // Limit to 5 suggestions
        
        if (this.filteredUsers.length === 0) {
            this.hide();
            return;
        }
        
        // Build dropdown HTML
        const html = this.filteredUsers.map(([userId, user], index) => {
            const avatarUrl = this.getAvatarUrl(user.avatar);
            return `
                <div class="mention-item ${index === 0 ? 'selected' : ''}" data-index="${index}">
                    <img src="${avatarUrl}" alt="${user.name}" class="mention-item-avatar">
                    <div class="mention-item-info">
                        <div class="mention-item-name">${escapeHtml(user.name)}</div>
                        <div class="mention-item-username">@${escapeHtml(user.username)}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        this.dropdown.innerHTML = html;
        this.selectedIndex = 0;
        this.isActive = true;
        
        // Position dropdown
        this.positionDropdown();
        this.dropdown.style.display = 'block';
        
        // Add click listeners
        this.dropdown.querySelectorAll('.mention-item').forEach(item => {
            item.addEventListener('click', () => {
                this.selectUser(parseInt(item.dataset.index));
            });
        });
    }
    
    positionDropdown() {
        const rect = this.textarea.getBoundingClientRect();
        this.dropdown.style.top = (this.textarea.offsetHeight) + 'px';
        this.dropdown.style.left = '0px';
    }
    
    getAvatarUrl(avatar) {
        if (avatar && avatar.startsWith('uploads/')) {
            return '/' + avatar;
        } else {
            return '/static/avatars/' + (avatar || 'default1.svg');
        }
    }
    
    handleKeydown(e) {
        if (!this.isActive) return;
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.selectedIndex = Math.min(this.selectedIndex + 1, this.filteredUsers.length - 1);
                this.updateSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
                this.updateSelection();
                break;
            case 'Enter':
            case 'Tab':
                if (this.filteredUsers.length > 0) {
                    e.preventDefault();
                    this.selectUser(this.selectedIndex);
                }
                break;
            case 'Escape':
                e.preventDefault();
                this.hide();
                break;
        }
    }
    
    updateSelection() {
        this.dropdown.querySelectorAll('.mention-item').forEach((item, index) => {
            if (index === this.selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }
    
    selectUser(index) {
        const [_, user] = this.filteredUsers[index];
        const value = this.textarea.value;
        const cursorPos = this.textarea.selectionStart;
        
        // Replace from @ to cursor with @username
        const before = value.substring(0, this.mentionStart);
        const after = value.substring(cursorPos);
        const mention = `@${user.username} `;
        
        this.textarea.value = before + mention + after;
        const newCursorPos = this.mentionStart + mention.length;
        this.textarea.setSelectionRange(newCursorPos, newCursorPos);
        
        // Trigger input event to update character count
        this.textarea.dispatchEvent(new Event('input'));
        
        this.hide();
        this.textarea.focus();
    }
    
    hide() {
        this.dropdown.style.display = 'none';
        this.isActive = false;
        this.selectedIndex = 0;
        this.filteredUsers = [];
    }
}

// Character counter for new comment
const newCommentTextarea = document.getElementById('newCommentText');
newCommentTextarea.addEventListener('input', function() {
    document.getElementById('charCount').textContent = this.value.length;
});

// Initialize auto-resize for main comment textarea
autoResizeTextarea(newCommentTextarea);

// Initialize mention autocomplete for main comment
const mainMentionAutocomplete = new MentionAutocomplete(newCommentTextarea, 'mentionDropdown');

// Handle audio file change
function handleCommentAudioChange(input) {
    const file = input.files[0];
    if (file) {
        const fileName = file.name;
        const fileSize = formatFileSize(file.size);
        
        // Show the upload section if it's hidden
        const audioSection = document.getElementById('commentAudioUploadSection');
        if (audioSection) {
            audioSection.style.display = 'block';
        }
        
        // Show preview
        const preview = document.getElementById('commentAudioPreview');
        const previewName = document.getElementById('commentAudioPreviewName');
        const previewSize = document.getElementById('commentAudioPreviewSize');
        
        if (preview && previewName && previewSize) {
            previewName.textContent = fileName;
            previewSize.textContent = fileSize;
            preview.style.display = 'block';
        }
        
        // Validate file type
        const allowedTypes = ['.webm', '.mp3', '.wav', '.ogg', '.m4a'];
        const fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
        if (!allowedTypes.includes(fileExt)) {
            alert(`Invalid file type. Allowed: ${allowedTypes.join(', ')}`);
            clearCommentAudio();
            return;
        }
    } else {
        clearCommentAudio();
    }
}

// Handle reply audio file change
function handleReplyAudioChange(commentId, input) {
    const file = input.files[0];
    if (file) {
        const fileName = file.name;
        const fileSize = formatFileSize(file.size);
        
        // Update button text
        document.getElementById(`replyAudioFileName-${commentId}`).textContent = fileName;
        
        // Show preview
        document.getElementById(`replyAudioPreviewName-${commentId}`).textContent = fileName;
        document.getElementById(`replyAudioPreviewSize-${commentId}`).textContent = fileSize;
        document.getElementById(`replyAudioPreview-${commentId}`).style.display = 'block';
        
        // Validate file type
        const allowedTypes = ['.webm', '.mp3', '.wav', '.ogg', '.m4a'];
        const fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
        if (!allowedTypes.includes(fileExt)) {
            alert(`Invalid file type. Allowed: ${allowedTypes.join(', ')}`);
            clearReplyAudio(commentId);
            return;
        }
    } else {
        clearReplyAudio(commentId);
    }
}

// Clear comment audio
function clearCommentAudio() {
    const fileInput = document.getElementById('commentAudioFile');
    const preview = document.getElementById('commentAudioPreview');
    const audioSection = document.getElementById('commentAudioUploadSection');
    
    if (fileInput) {
        fileInput.value = '';
    }
    if (preview) {
        preview.style.display = 'none';
    }
    // Hide the upload section after clearing
    if (audioSection) {
        audioSection.style.display = 'none';
    }
}

// Clear reply audio
function clearReplyAudio(commentId) {
    const fileInput = document.getElementById(`replyAudioFile-${commentId}`);
    if (fileInput) {
        fileInput.value = '';
        document.getElementById(`replyAudioFileName-${commentId}`).textContent = 'Choose audio file...';
        document.getElementById(`replyAudioPreview-${commentId}`).style.display = 'none';
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Add current user to mentions
addUserToMentions({{ current_user.id }}, '{{ current_user.username }}', '{{ current_user.name }}', '{{ current_user.avatar }}');

// Load comments when page loads
window.addEventListener('load', function() {
    loadComments();
    updateCharCount(); // Initialize character count
});

// Load comments from server
async function loadComments(page = 1) {
    try {
        const offset = (page - 1) * 10;
        const response = await fetch(`/api/comments/question/${questionId}?offset=${offset}&limit=10&sort=${currentSort}`);
        const data = await response.json();
        
        if (data.success) {
            if (page === 1) {
                displayComments(data.comments);
            } else {
                appendComments(data.comments);
            }
            
            document.getElementById('commentsCount').textContent = data.total;
            currentPage = page;
            hasMoreComments = data.has_more;
            
            // Show/hide load more button
            document.getElementById('loadMoreContainer').style.display = hasMoreComments ? 'block' : 'none';
            
            // Keep replies expanded after reload (if user just posted a reply)
            if (window.keepExpandedAfterReload) {
                const commentId = window.keepExpandedAfterReload;
                setTimeout(() => {
                    const repliesContainer = document.getElementById(`replies-${commentId}`);
                    if (repliesContainer && repliesContainer.style.display === 'none') {
                        toggleReplies(commentId);
                    }
                    window.keepExpandedAfterReload = null;
                }, 100);
            }
        }
    } catch (error) {
        console.error('Error loading comments:', error);
        document.getElementById('commentsList').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Failed to load comments. Please try again later.
            </div>`;
    }
}

// Display comments in the list
function displayComments(comments) {
    const container = document.getElementById('commentsList');
    
    if (comments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-comment-slash fa-2x mb-2"></i>
                <p>No comments yet. Be the first to share your script!</p>
            </div>`;
        return;
    }
    
    // Add all users from comments to available mentions
    comments.forEach(comment => {
        addUserToMentions(comment.user_id, comment.username, comment.user_name, comment.user_avatar);
        if (comment.replies && comment.replies.length > 0) {
            comment.replies.forEach(reply => {
                addUserToMentions(reply.user_id, reply.username, reply.user_name, reply.user_avatar);
            });
        }
    });
    
    container.innerHTML = comments.map(comment => createCommentHTML(comment)).join('');
}

// Append more comments (for pagination)
function appendComments(comments) {
    const container = document.getElementById('commentsList');
    
    // Add all users from comments to available mentions
    comments.forEach(comment => {
        addUserToMentions(comment.user_id, comment.username, comment.user_name, comment.user_avatar);
        if (comment.replies && comment.replies.length > 0) {
            comment.replies.forEach(reply => {
                addUserToMentions(reply.user_id, reply.username, reply.user_name, reply.user_avatar);
            });
        }
    });
    
    container.insertAdjacentHTML('beforeend', comments.map(comment => createCommentHTML(comment)).join(''));
}

// Create HTML for a single comment
function createCommentHTML(comment) {
    const isOwn = comment.user_id === {{ current_user.id }};
    const isAdmin = {{ 'true' if current_user.is_admin else 'false' }};
    const timeAgo = getTimeAgo(comment.created_at);
    const fullDate = getFullDate(comment.created_at);
    const editedBadge = comment.is_edited ? '<small class="text-muted ms-1">(edited)</small>' : '';
    const pinnedBadge = comment.is_pinned ? '<span class="badge bg-warning text-dark ms-2"><i class="fas fa-thumbtack me-1"></i>Pinned</span>' : '';
    const adminBadge = comment.is_admin ? '<i class="fas fa-check-circle text-primary ms-1" title="Verified"></i>' : '';
    const avatarUrl = getAvatarUrl(comment.user_avatar);
    
    // Get dislike count (if available in the API response)
    const dislikesCount = comment.dislikes_count || 0;
    const userHasDisliked = comment.user_has_disliked || false;
    
    return `
        <div class="comment" data-comment-id="${comment.id}" data-username="${escapeHtml(comment.username)}" data-user-name="${escapeHtml(comment.user_name)}">
            <div class="d-flex align-items-start">
                <div class="comment-avatar">
                    <img src="${avatarUrl}" alt="${escapeHtml(comment.user_name)}" class="avatar-img">
                </div>
                <div class="flex-grow-1">
                    <div class="comment-header mb-2">
                        <div class="d-flex align-items-center flex-wrap">
                            <strong class="comment-user-name">${escapeHtml(comment.user_name)}</strong>
                            ${adminBadge}
                            <small class="text-muted ms-2">${timeAgo}</small>
                            ${editedBadge}
                            ${pinnedBadge}
                        </div>
                    </div>
                    <div class="comment-content mb-2" id="content-${comment.id}">
                        ${parseMentions(escapeHtml(comment.content))}
                        ${comment.audio_url ? `
                            <div class="mt-2">
                                <div class="audio-player-wrapper">
                                    <audio controls class="comment-audio-player">
                                        <source src="/${comment.audio_url}" type="audio/webm">
                                        <source src="/${comment.audio_url}" type="audio/mpeg">
                                        <source src="/${comment.audio_url}" type="audio/wav">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="d-flex align-items-center gap-3 comment-actions">
                        <button class="btn btn-link btn-sm text-decoration-none p-0 ${comment.user_has_liked ? 'text-primary' : 'text-muted'}" onclick="toggleLike(${comment.id})" id="likeBtn-${comment.id}" title="Like this comment">
                            <i class="fas fa-thumbs-up me-1"></i>
                            <span id="likeCount-${comment.id}">${comment.likes_count > 0 ? comment.likes_count : ''}</span>
                        </button>
                        <button class="btn btn-link btn-sm text-decoration-none p-0 ${userHasDisliked ? 'text-danger' : 'text-muted'}" onclick="toggleDislike(${comment.id})" id="dislikeBtn-${comment.id}" title="Dislike this comment">
                            <i class="fas fa-thumbs-down me-1"></i>
                            <span id="dislikeCount-${comment.id}">${dislikesCount > 0 ? dislikesCount : ''}</span>
                        </button>
                        <button class="btn btn-link btn-sm text-decoration-none p-0 text-muted" onclick="showReplyForm(${comment.id}, '${escapeHtml(comment.username)}')">
                            <i class="fas fa-comment me-1"></i>Reply
                        </button>
                        <div class="dropdown ms-auto">
                            <button class="btn btn-link btn-sm text-decoration-none p-0 text-muted" type="button" id="commentMenu${comment.id}" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="commentMenu${comment.id}">
                                ${isOwn ? `
                                    <li><a class="dropdown-item" href="#" onclick="editComment(${comment.id}); return false;"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                ` : ''}
                                ${isOwn || isAdmin ? `
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteComment(${comment.id}); return false;"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                ` : ''}
                                ${isAdmin && !comment.parent_id ? `
                                    <li><a class="dropdown-item" href="#" onclick="togglePin(${comment.id}); return false;"><i class="fas fa-thumbtack me-2"></i>${comment.is_pinned ? 'Unpin' : 'Pin'}</a></li>
                                ` : ''}
                                <li><a class="dropdown-item" href="#" onclick="copyCommentLink(${comment.id}); return false;"><i class="fas fa-link me-2"></i>Copy link</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Show Replies Button (hidden if no replies) -->
                    ${comment.replies_count > 0 ? `
                        <div class="mt-2">
                            <button class="btn btn-link btn-sm text-decoration-none p-0" 
                                    onclick="toggleReplies(${comment.id})" 
                                    id="toggleRepliesBtn-${comment.id}">
                                <i class="fas fa-chevron-down me-1" id="toggleIcon-${comment.id}"></i>
                                <span id="toggleText-${comment.id}">Show ${comment.replies_count} ${comment.replies_count === 1 ? 'reply' : 'replies'}</span>
                            </button>
                        </div>
                    ` : ''}
                    
                    <!-- Reply Form (hidden by default) -->
                    <div id="replyForm-${comment.id}" class="mt-2" style="display: none; position: relative;">
                        <textarea class="form-control form-control-sm auto-resize-textarea" rows="3" 
                                  placeholder="Write a reply... (Type @ to mention someone)" maxlength="2200" 
                                  id="replyText-${comment.id}"
                                  oninput="autoResizeTextarea(this)"></textarea>
                        <div id="replyMentionDropdown-${comment.id}" class="mention-dropdown"></div>
                        <div class="mt-2 audio-upload-container">
                            <input type="file" class="d-none" id="replyAudioFile-${comment.id}" accept="audio/*" onchange="handleReplyAudioChange(${comment.id}, this)" />
                            <button type="button" class="btn btn-outline-secondary btn-sm w-100 audio-upload-btn" onclick="document.getElementById('replyAudioFile-${comment.id}').click()">
                                <i class="fas fa-upload me-2"></i>
                                <span id="replyAudioFileName-${comment.id}">Choose audio file...</span>
                            </button>
                            <div id="replyAudioPreview-${comment.id}" class="mt-2 audio-preview" style="display: none;">
                                <div class="d-flex align-items-center justify-content-between bg-light rounded p-2">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file-audio text-primary me-2"></i>
                                        <div>
                                            <small class="d-block fw-bold" id="replyAudioPreviewName-${comment.id}"></small>
                                            <small class="text-muted" id="replyAudioPreviewSize-${comment.id}"></small>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearReplyAudio(${comment.id})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-1">
                            <button class="btn btn-primary btn-sm" onclick="postReply(${comment.id})">
                                <i class="fas fa-paper-plane me-1"></i>Reply
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="hideReplyForm(${comment.id})">
                                Cancel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Replies Container (hidden by default) -->
                    <div id="replies-${comment.id}" class="replies-container" style="display: none;">
                        ${comment.replies ? comment.replies.map(reply => createReplyHTML(reply)).join('') : ''}
                    </div>
                </div>
            </div>
        </div>`;
}

// Create HTML for a reply
function createReplyHTML(reply) {
    const isOwn = reply.user_id === {{ current_user.id }};
    const isAdmin = {{ 'true' if current_user.is_admin else 'false' }};
    const timeAgo = getTimeAgo(reply.created_at);
    const fullDate = getFullDate(reply.created_at);
    const editedBadge = reply.is_edited ? '<small class="text-muted ms-1">(edited)</small>' : '';
    const adminBadge = reply.is_admin ? '<i class="fas fa-check-circle text-primary ms-1" title="Verified"></i>' : '';
    const avatarUrl = getAvatarUrl(reply.user_avatar);
    
    const dislikesCount = reply.dislikes_count || 0;
    const userHasDisliked = reply.user_has_disliked || false;
    
    return `
        <div class="reply" data-comment-id="${reply.id}">
            <div class="reply-connector"></div>
            <div class="d-flex align-items-start">
                <div class="comment-avatar">
                    <img src="${avatarUrl}" alt="${escapeHtml(reply.user_name)}" class="avatar-img avatar-img-small">
                </div>
                <div class="flex-grow-1">
                    <div class="comment-header mb-2">
                        <div class="d-flex align-items-center flex-wrap">
                            <strong class="comment-user-name">${escapeHtml(reply.user_name)}</strong>
                            ${adminBadge}
                            <small class="text-muted ms-2">${timeAgo}</small>
                            ${editedBadge}
                        </div>
                    </div>
                    <div class="comment-content mb-2" id="content-${reply.id}">
                        ${parseMentions(escapeHtml(reply.content))}
                        ${reply.audio_url ? `
                            <div class="mt-2">
                                <div class="audio-player-wrapper">
                                    <audio controls class="comment-audio-player">
                                        <source src="/${reply.audio_url}" type="audio/webm">
                                        <source src="/${reply.audio_url}" type="audio/mpeg">
                                        <source src="/${reply.audio_url}" type="audio/wav">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="d-flex align-items-center gap-3 comment-actions">
                        <button class="btn btn-link btn-sm text-decoration-none p-0 ${reply.user_has_liked ? 'text-primary' : 'text-muted'}" onclick="toggleLike(${reply.id})" id="likeBtn-${reply.id}" title="Like this reply">
                            <i class="fas fa-thumbs-up me-1"></i>
                            <span id="likeCount-${reply.id}">${reply.likes_count > 0 ? reply.likes_count : ''}</span>
                        </button>
                        <button class="btn btn-link btn-sm text-decoration-none p-0 ${userHasDisliked ? 'text-danger' : 'text-muted'}" onclick="toggleDislike(${reply.id})" id="dislikeBtn-${reply.id}" title="Dislike this reply">
                            <i class="fas fa-thumbs-down me-1"></i>
                            <span id="dislikeCount-${reply.id}">${dislikesCount > 0 ? dislikesCount : ''}</span>
                        </button>
                        <div class="dropdown ms-auto">
                            <button class="btn btn-link btn-sm text-decoration-none p-0 text-muted" type="button" id="replyMenu${reply.id}" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="replyMenu${reply.id}">
                                ${isOwn ? `
                                    <li><a class="dropdown-item" href="#" onclick="editComment(${reply.id}); return false;"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                ` : ''}
                                ${isOwn || isAdmin ? `
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteComment(${reply.id}); return false;"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                ` : ''}
                                <li><a class="dropdown-item" href="#" onclick="copyCommentLink(${reply.id}); return false;"><i class="fas fa-link me-2"></i>Copy link</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
}

// Post a new comment
async function postComment() {
    const textarea = document.getElementById('newCommentText');
    const content = textarea.value.trim();
    const audioFile = document.getElementById('commentAudioFile').files[0];
    
    if (!content && !audioFile) {
        alert('Please write something or upload an audio file before posting.');
        return;
    }
    
    const btn = document.getElementById('postCommentBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Posting...';
    
    try {
        const formData = new FormData();
        formData.append('content', content);
        if (audioFile) {
            formData.append('audio', audioFile);
        }
        
        const response = await fetch(`/api/comments/question/${questionId}`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            textarea.value = '';
            document.getElementById('charCount').textContent = '0';
            clearCommentAudio(); // Clear file input and preview
            loadComments(1); // Reload comments
            showToast('Comment posted successfully!', 'success');
        } else {
            alert(data.error || data.message || 'Failed to post comment');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error posting comment. Please try again.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Post Comment';
    }
}

// Store reply mention autocomplete instances
const replyMentionInstances = new Map();

// Toggle replies visibility
function toggleReplies(commentId) {
    const repliesContainer = document.getElementById(`replies-${commentId}`);
    const toggleIcon = document.getElementById(`toggleIcon-${commentId}`);
    const toggleText = document.getElementById(`toggleText-${commentId}`);
    const toggleBtn = document.getElementById(`toggleRepliesBtn-${commentId}`);
    
    if (repliesContainer.style.display === 'none') {
        // Show replies
        repliesContainer.style.display = 'block';
        toggleIcon.classList.remove('fa-chevron-down');
        toggleIcon.classList.add('fa-chevron-up');
        
        // Count replies
        const replyCount = repliesContainer.querySelectorAll('.reply').length;
        toggleText.textContent = `Hide ${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}`;
    } else {
        // Hide replies
        repliesContainer.style.display = 'none';
        toggleIcon.classList.remove('fa-chevron-up');
        toggleIcon.classList.add('fa-chevron-down');
        
        // Count replies
        const replyCount = repliesContainer.querySelectorAll('.reply').length;
        toggleText.textContent = `Show ${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}`;
    }
}

// Show reply form
function showReplyForm(commentId, username) {
    const replyForm = document.getElementById(`replyForm-${commentId}`);
    const replyTextarea = document.getElementById(`replyText-${commentId}`);
    
    replyForm.style.display = 'block';
    
    // Auto-tag the user being replied to (user can delete it)
    if (username && replyTextarea.value === '') {
        replyTextarea.value = `@${username} `;
        // Set cursor after the mention
        setTimeout(() => {
            replyTextarea.setSelectionRange(replyTextarea.value.length, replyTextarea.value.length);
            replyTextarea.focus();
        }, 10);
    } else {
        replyTextarea.focus();
    }
    
    // Initialize auto-resize for this textarea
    autoResizeTextarea(replyTextarea);
    
    // Initialize mention autocomplete for reply if not already done
    if (!replyMentionInstances.has(commentId)) {
        const dropdownId = `replyMentionDropdown-${commentId}`;
        replyMentionInstances.set(commentId, new MentionAutocomplete(replyTextarea, dropdownId));
    }
    
    // Auto-expand replies when user wants to reply
    const repliesContainer = document.getElementById(`replies-${commentId}`);
    if (repliesContainer && repliesContainer.style.display === 'none') {
        toggleReplies(commentId);
    }
}

// Hide reply form
function hideReplyForm(commentId) {
    const replyTextarea = document.getElementById(`replyText-${commentId}`);
    replyTextarea.value = '';
    replyTextarea.style.height = 'auto'; // Reset height
    clearReplyAudio(commentId); // Clear file input and preview
    document.getElementById(`replyForm-${commentId}`).style.display = 'none';
}

// Post a reply
async function postReply(parentId) {
    const textarea = document.getElementById(`replyText-${parentId}`);
    const content = textarea.value.trim();
    const audioFile = document.getElementById(`replyAudioFile-${parentId}`).files[0];
    
    if (!content && !audioFile) {
        alert('Please write something or upload an audio file before posting.');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('content', content);
        if (audioFile) {
            formData.append('audio', audioFile);
        }
        
        const response = await fetch(`/api/comments/${parentId}/reply`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            hideReplyForm(parentId);
            // Mark this comment to keep expanded after reload
            window.keepExpandedAfterReload = parentId;
            loadComments(1); // Reload to show new reply
            showToast('Reply posted successfully!', 'success');
        } else {
            alert(data.error || data.message || 'Failed to post reply');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error posting reply. Please try again.');
    }
}

// Toggle like on a comment
async function toggleLike(commentId) {
    try {
        const response = await fetch(`/api/comments/${commentId}/like`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            const btn = document.getElementById(`likeBtn-${commentId}`);
            const count = document.getElementById(`likeCount-${commentId}`);
            const icon = btn.querySelector('i');
            
            // Update count text - show number only if > 0
            count.textContent = data.likes_count > 0 ? data.likes_count : '';
            
            // Update icon and button styling
            if (data.user_has_liked) {
                icon.classList.add('text-primary');
                btn.classList.remove('text-muted');
                btn.classList.add('text-primary');
            } else {
                icon.classList.remove('text-primary');
                btn.classList.remove('text-primary');
                btn.classList.add('text-muted');
            }
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Edit comment
async function editComment(commentId) {
    const contentEl = document.getElementById(`content-${commentId}`);
    const currentContent = contentEl.textContent.trim();
    
    const newContent = prompt('Edit your comment:', currentContent);
    
    if (newContent === null || newContent.trim() === '') {
        return;
    }
    
    try {
        const response = await fetch(`/api/comments/${commentId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: newContent})
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadComments(1);
            showToast('Comment updated successfully!', 'success');
        } else {
            alert(data.message || 'Failed to update comment');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating comment. Please try again.');
    }
}

// Delete comment
async function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/comments/${commentId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadComments(1);
            showToast('Comment deleted successfully!', 'success');
        } else {
            alert(data.message || 'Failed to delete comment');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting comment. Please try again.');
    }
}

// Toggle pin (admin only)
async function togglePin(commentId) {
    try {
        const response = await fetch(`/api/comments/${commentId}/pin`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadComments(1);
            showToast(`Comment ${data.action}!`, 'success');
        } else {
            alert(data.message || 'Failed to toggle pin');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Update character count
function updateCharCount() {
    const textarea = document.getElementById('newCommentText');
    const charCount = document.getElementById('charCount');
    if (textarea && charCount) {
        charCount.textContent = textarea.value.length;
    }
}

// Format text functions (placeholder - can be enhanced)
function formatText(type) {
    const textarea = document.getElementById('newCommentText');
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    
    let formatted = '';
    switch(type) {
        case 'bold':
            formatted = selectedText ? `**${selectedText}**` : '****';
            break;
        case 'italic':
            formatted = selectedText ? `*${selectedText}*` : '**';
            break;
        case 'underline':
            formatted = selectedText ? `__${selectedText}__` : '____';
            break;
    }
    
    textarea.value = before + formatted + after;
    textarea.focus();
    textarea.setSelectionRange(start, start + formatted.length);
    updateCharCount();
}

function insertLink() {
    const textarea = document.getElementById('newCommentText');
    if (!textarea) return;
    
    const url = prompt('Enter URL:');
    if (url) {
        const start = textarea.selectionStart;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(textarea.selectionEnd);
        textarea.value = before + `[Link](${url})` + after;
        updateCharCount();
    }
}

function insertEmoji() {
    // Placeholder - can be enhanced with emoji picker
    const textarea = document.getElementById('newCommentText');
    if (!textarea) return;
    
    const emoji = prompt('Enter emoji (e.g., ):');
    if (emoji) {
        const start = textarea.selectionStart;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(textarea.selectionEnd);
        textarea.value = before + emoji + after;
        textarea.focus();
        textarea.setSelectionRange(start + emoji.length, start + emoji.length);
        updateCharCount();
    }
}

function triggerMention() {
    const textarea = document.getElementById('newCommentText');
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(textarea.selectionEnd);
    textarea.value = before + '@' + after;
    textarea.focus();
    textarea.setSelectionRange(start + 1, start + 1);
    
    // Trigger mention autocomplete
    const event = new Event('input', { bubbles: true });
    textarea.dispatchEvent(event);
    updateCharCount();
}

function toggleAudioUpload() {
    const audioSection = document.getElementById('commentAudioUploadSection');
    const fileInput = document.getElementById('commentAudioFile');
    
    if (audioSection && fileInput) {
        // Show the section first
        audioSection.style.display = 'block';
        // Then trigger file picker
        setTimeout(() => {
            fileInput.click();
        }, 100);
    }
}

// Toggle dislike (placeholder - implement if backend supports it)
async function toggleDislike(commentId) {
    // Placeholder function - implement if backend supports dislikes
    console.log('Dislike toggle not implemented yet');
    // Similar to toggleLike but for dislikes
}

// Copy comment link
function copyCommentLink(commentId) {
    const url = `${window.location.origin}${window.location.pathname}#comment-${commentId}`;
    navigator.clipboard.writeText(url).then(() => {
        showToast('Comment link copied to clipboard!', 'success');
    }).catch(() => {
        alert('Failed to copy link');
    });
}

// Sort comments
function sortComments(sort) {
    currentSort = sort;
    
    // Update dropdown if it exists
    const select = document.getElementById('commentsSortSelect');
    if (select) {
        select.value = sort;
    }
    
    loadComments(1);
}

// Load more comments
function loadMoreComments() {
    loadComments(currentPage + 1);
}

// Utility: Get relative time
function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
    
    return date.toLocaleDateString();
}

// Get full date formatted as DD/MM/YYYY
function getFullDate(dateString) {
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// Utility: Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Utility: Show toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3000);
}

// Generate avatar URL using DiceBear API
function getAvatarUrl(userAvatar) {
    // Use the actual user avatar from the database
    // If it starts with 'uploads/', it's a custom uploaded avatar
    // Otherwise, it's a default avatar from static/avatars/
    if (userAvatar && userAvatar.startsWith('uploads/')) {
        return '/' + userAvatar;
    } else {
        // Default avatar from static/avatars/
        const avatarFile = userAvatar || 'default1.svg';
        return '/static/avatars/' + avatarFile;
    }
}

// Generate a consistent color based on a string (for avatar background)
function generateColorFromString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    // Generate pleasant, distinct colors
    const colors = ['0d6efd', '6610f2', '6f42c1', 'd63384', 'dc3545', 'fd7e14', 'ffc107', '198754', '20c997', '0dcaf0'];
    const index = Math.abs(hash) % colors.length;
    return colors[index];
}

// Sync mobile recording buttons with desktop
</script>

<!-- Mobile Floating Navigation Buttons -->
<div class="mobile-nav d-md-none">
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary" title="Dashboard">
        <i class="fas fa-home"></i>
    </a>
    <a href="{{ url_for('practice_mode.index') }}" class="btn btn-secondary" title="Back">
        <i class="fas fa-arrow-left"></i>
    </a>
</div>

{% endblock %}


